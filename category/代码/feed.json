{
    "version": "https://jsonfeed.org/version/1",
    "title": "Amentiraz • All posts by \"代码\" category",
    "description": "",
    "home_page_url": "http://Amentiraz.github.io",
    "items": [
        {
            "id": "http://amentiraz.github.io/2024/06/10/%E5%88%86%E5%B8%83%E5%BC%8F%E5%A4%A7%E4%BD%9C%E4%B8%9A/",
            "url": "http://amentiraz.github.io/2024/06/10/%E5%88%86%E5%B8%83%E5%BC%8F%E5%A4%A7%E4%BD%9C%E4%B8%9A/",
            "title": "分布式大作业",
            "date_published": "2024-06-10T06:23:11.000Z",
            "content_html": "<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>配环境比写代码难一万倍 QAQ</p>\n<span id=\"more\"></span>\n<p>不要使用 Docker 配置多节点环境！</p>\n<p>不要使用 Docker 配置多节点环境！</p>\n<p>不要使用 Docker 配置多节点环境！</p>\n<p>如果你要使用 docker 请使用老师给的第二个 pdf 文件上的方案也就是配置单节点的环境。这个方案是可行的。但我并没有走这个方案，因为配多节点的时候我的系统环境产生了不可名状的变化，导致我配置单节点时仍然报错，所以这篇博客是针对本地配置 Hadoop 的文章</p>\n<p>在整个问题中，你会遇到非常多次的需要下载老版本的情况，请认准 release archives 字样，它会带你去旧版本的下载界面，你会遇到多种多样的报错，请在报错时尝试清空 namenode 和 datanode 里面的文件重新配置。</p>\n<h1 id=\"环境配置遇到的问题及解决方案\"><a class=\"markdownIt-Anchor\" href=\"#环境配置遇到的问题及解决方案\">#</a> 环境配置遇到的问题及解决方案</h1>\n<h2 id=\"无法解压targz文件\"><a class=\"markdownIt-Anchor\" href=\"#无法解压targz文件\">#</a> 无法解压 tar.gz 文件？</h2>\n<p>在<strong>打开管理员模式的命令提示符</strong>中，使用指令 tar -zxvf fileName.tar.gz</p>\n<h2 id=\"nodemanager启动时遇到错误\"><a class=\"markdownIt-Anchor\" href=\"#nodemanager启动时遇到错误\">#</a> NodeManager 启动时遇到错误</h2>\n<p>NodeManager 启动时遇到了一个 java.lang.ExceptionInInitializerError<br>\n 原因是 JAVA 版本太高了，我用的是 java22，请重新下载 JAVA8 即 1.8 的版本<br>\n GPT 解释：特别是 Java 9 及其以上版本引入了模块系统（Jigsaw 项目），导致一些反射操作变得不可访问。而许多 Hadoop 的库和依赖项（比如 Guice 和 CGLIB）在设计时没有考虑到这些新的限制<br>\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cub3JhY2xlLmNvbS9qYXZhL3RlY2hub2xvZ2llcy9qYXZhc2UvamF2YXNlLWpkazgtZG93bmxvYWRzLmh0bWw=\"> JAVA1.8 下载地址</span></p>\n<h2 id=\"pyspark指令报错\"><a class=\"markdownIt-Anchor\" href=\"#pyspark指令报错\">#</a> pyspark 指令报错</h2>\n<p>你的 Python 版本太高了<br>\n我这里直接采用了老师的那个版本<br>\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucHl0aG9uLm9yZy9mdHAvcHl0aG9uLzMuNi4zL3B5dGhvbi0zLjYuMy1hbWQ2NC5leGU=\"> python3.6.3</span></p>\n<h2 id=\"卡在running-job后不动了\"><a class=\"markdownIt-Anchor\" href=\"#卡在running-job后不动了\">#</a> 卡在 running job 后不动了</h2>\n<p>修改 xml 里面的配置，包括 yarn-site、hdfs-site、core-site、mapred-site，后面会给出我的配置和详细的信息。</p>\n<h2 id=\"显示不了中文字符\"><a class=\"markdownIt-Anchor\" href=\"#显示不了中文字符\">#</a> 显示不了中文字符</h2>\n<p>在控制面板的时钟与区域 -&gt; 区域 -&gt; 管理 -&gt; 更改系统区域设置 -&gt; 选用 beta 版<br>\n重启电脑即可</p>\n<h1 id=\"环境配置\"><a class=\"markdownIt-Anchor\" href=\"#环境配置\">#</a> 环境配置</h1>\n<p>Hadoop 3.0.0<br>\npython 3.6.3<br>\nJava 1.8<br>\nmaven 3.9.7<br>\n 系统变量：<img data-src=\"1.png\" alt=\"\"></p>\n<p>我的主机名是 LAPTOP-1A91HHJ4, 如果你要查看自己的主机名可在命令指示符中输入’hostname’，即可得到主机名</p>\n<h2 id=\"core-siteyml\"><a class=\"markdownIt-Anchor\" href=\"#core-siteyml\">#</a> core-site.yml</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class=\"line\">&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;configuration.xsl&quot;?&gt;</span><br><span class=\"line\">&lt;!--</span><br><span class=\"line\">  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class=\"line\">  you may not use this file except in compliance with the License.</span><br><span class=\"line\">  You may obtain a copy of the License at</span><br><span class=\"line\"></span><br><span class=\"line\">    http://www.apache.org/licenses/LICENSE-2.0</span><br><span class=\"line\"></span><br><span class=\"line\">  Unless required by applicable law or agreed to in writing, software</span><br><span class=\"line\">  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class=\"line\">  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class=\"line\">  See the License for the specific language governing permissions and</span><br><span class=\"line\">  limitations under the License. See accompanying LICENSE file.</span><br><span class=\"line\">--&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!-- Put site-specific property overrides in this file. --&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;configuration&gt;</span><br><span class=\"line\">    &lt;property&gt;</span><br><span class=\"line\">    &lt;name&gt;fs.defaultFS&lt;/name&gt;</span><br><span class=\"line\">    &lt;value&gt;hdfs://localhost:9000&lt;/value&gt;</span><br><span class=\"line\">    &lt;/property&gt;</span><br><span class=\"line\">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>\n<h2 id=\"hdfs-siteyml\"><a class=\"markdownIt-Anchor\" href=\"#hdfs-siteyml\">#</a> hdfs-site.yml</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class=\"line\">&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;configuration.xsl&quot;?&gt;</span><br><span class=\"line\">&lt;!--</span><br><span class=\"line\">  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class=\"line\">  you may not use this file except in compliance with the License.</span><br><span class=\"line\">  You may obtain a copy of the License at</span><br><span class=\"line\"></span><br><span class=\"line\">    http://www.apache.org/licenses/LICENSE-2.0</span><br><span class=\"line\"></span><br><span class=\"line\">  Unless required by applicable law or agreed to in writing, software</span><br><span class=\"line\">  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class=\"line\">  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class=\"line\">  See the License for the specific language governing permissions and</span><br><span class=\"line\">  limitations under the License. See accompanying LICENSE file.</span><br><span class=\"line\">--&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!-- Put site-specific property overrides in this file. --&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;configuration&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;property&gt;</span><br><span class=\"line\">       &lt;name&gt;dfs.replication&lt;/name&gt;</span><br><span class=\"line\">       &lt;value&gt;1&lt;/value&gt;</span><br><span class=\"line\">   &lt;/property&gt;</span><br><span class=\"line\">   &lt;property&gt;</span><br><span class=\"line\">       &lt;name&gt;dfs.namenode.name.dir&lt;/name&gt;</span><br><span class=\"line\">       &lt;value&gt;file:///C:/Hadoop/data/namenode&lt;/value&gt;</span><br><span class=\"line\">   &lt;/property&gt;</span><br><span class=\"line\">   &lt;property&gt;</span><br><span class=\"line\">       &lt;name&gt;dfs.datanode.data.dir&lt;/name&gt;</span><br><span class=\"line\">       &lt;value&gt;file:///C:/Hadoop/data/datanode&lt;/value&gt;</span><br><span class=\"line\">   &lt;/property&gt;</span><br><span class=\"line\">&lt;property&gt;</span><br><span class=\"line\">        &lt;name&gt;dfs.namenode.http-address&lt;/name&gt;</span><br><span class=\"line\">        &lt;value&gt;LAPTOP-1A91HHJ4:9089&lt;/value&gt;</span><br><span class=\"line\">    &lt;/property&gt;</span><br><span class=\"line\">    &lt;property&gt;</span><br><span class=\"line\">        &lt;name&gt;dfs.datanode.http.address&lt;/name&gt;</span><br><span class=\"line\">        &lt;value&gt;LAPTOP-1A91HHJ4:9088&lt;/value&gt;</span><br><span class=\"line\">    &lt;/property&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>\n<h2 id=\"yarn-site\"><a class=\"markdownIt-Anchor\" href=\"#yarn-site\">#</a> yarn-site</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class=\"line\">&lt;!--</span><br><span class=\"line\">  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class=\"line\">  you may not use this file except in compliance with the License.</span><br><span class=\"line\">  You may obtain a copy of the License at</span><br><span class=\"line\"></span><br><span class=\"line\">    http://www.apache.org/licenses/LICENSE-2.0</span><br><span class=\"line\"></span><br><span class=\"line\">  Unless required by applicable law or agreed to in writing, software</span><br><span class=\"line\">  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class=\"line\">  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class=\"line\">  See the License for the specific language governing permissions and</span><br><span class=\"line\">  limitations under the License. See accompanying LICENSE file.</span><br><span class=\"line\">--&gt;</span><br><span class=\"line\">&lt;configuration&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!-- Site specific YARN configuration properties --&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;property&gt;</span><br><span class=\"line\">    \t&lt;name&gt;yarn.nodemanager.aux-services&lt;/name&gt;</span><br><span class=\"line\">    \t&lt;value&gt;mapreduce_shuffle&lt;/value&gt;</span><br><span class=\"line\">   &lt;/property&gt;</span><br><span class=\"line\">   &lt;property&gt;</span><br><span class=\"line\">      \t&lt;name&gt;yarn.nodemanager.auxservices.mapreduce.shuffle.class&lt;/name&gt;  </span><br><span class=\"line\">\t&lt;value&gt;org.apache.hadoop.mapred.ShuffleHandler&lt;/value&gt;</span><br><span class=\"line\">   &lt;/property&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;property&gt;</span><br><span class=\"line\">    &lt;name&gt;yarn.resourcemanager.hostname&lt;/name&gt;</span><br><span class=\"line\">    &lt;value&gt;LAPTOP-1A91HHJ4&lt;/value&gt;</span><br><span class=\"line\">&lt;/property&gt;</span><br><span class=\"line\">&lt;property&gt;</span><br><span class=\"line\">    &lt;name&gt;yarn.resourcemanager.bind-host&lt;/name&gt;</span><br><span class=\"line\">    &lt;value&gt;0.0.0.0&lt;/value&gt;</span><br><span class=\"line\">&lt;/property&gt;</span><br><span class=\"line\">&lt;property&gt;</span><br><span class=\"line\">    &lt;name&gt;yarn.nodemanager.resource.memory-mb&lt;/name&gt;</span><br><span class=\"line\">    &lt;value&gt;20480&lt;/value&gt; &lt;!-- 根据你的集群配置调整 --&gt;</span><br><span class=\"line\">&lt;/property&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;property&gt;</span><br><span class=\"line\">    &lt;name&gt;yarn.scheduler.minimum-allocation-mb&lt;/name&gt;</span><br><span class=\"line\">    &lt;value&gt;2048&lt;/value&gt; &lt;!-- 根据你的集群配置调整 --&gt;</span><br><span class=\"line\">&lt;/property&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;property&gt;</span><br><span class=\"line\">    &lt;name&gt;yarn.nodemanager.resource.cpu-vcores&lt;/name&gt;</span><br><span class=\"line\">    &lt;value&gt;4&lt;/value&gt; &lt;!-- 根据你的集群配置调整 --&gt;</span><br><span class=\"line\">&lt;/property&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;property&gt;</span><br><span class=\"line\">    &lt;name&gt;yarn.nodemanager.vmem-pmem-ratio&lt;/name&gt;</span><br><span class=\"line\">    &lt;value&gt;2.1&lt;/value&gt;</span><br><span class=\"line\">&lt;/property&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;property&gt;</span><br><span class=\"line\">    &lt;name&gt;yarn.scheduler.maximum-allocation-vcores&lt;/name&gt;</span><br><span class=\"line\">    &lt;value&gt;4&lt;/value&gt; &lt;!-- 根据你的集群配置调整 --&gt;</span><br><span class=\"line\">&lt;/property&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;property&gt;</span><br><span class=\"line\">    &lt;name&gt;yarn.resourcemanager.address&lt;/name&gt;</span><br><span class=\"line\">    &lt;value&gt;LAPTOP-1A91HHJ4:8032&lt;/value&gt;</span><br><span class=\"line\">&lt;/property&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;property&gt;</span><br><span class=\"line\">    &lt;name&gt;yarn.resourcemanager.scheduler.address&lt;/name&gt;</span><br><span class=\"line\">    &lt;value&gt;LAPTOP-1A91HHJ4:8030&lt;/value&gt;</span><br><span class=\"line\">&lt;/property&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;property&gt;</span><br><span class=\"line\">    &lt;name&gt;yarn.resourcemanager.resource-tracker.address&lt;/name&gt;</span><br><span class=\"line\">    &lt;value&gt;LAPTOP-1A91HHJ4:8031&lt;/value&gt;</span><br><span class=\"line\">&lt;/property&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;property&gt;</span><br><span class=\"line\">    &lt;name&gt;yarn.resourcemanager.admin.address&lt;/name&gt;</span><br><span class=\"line\">    &lt;value&gt;LAPTOP-1A91HHJ4:8033&lt;/value&gt;</span><br><span class=\"line\">&lt;/property&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;property&gt;</span><br><span class=\"line\">    &lt;name&gt;yarn.resourcemanager.webapp.address&lt;/name&gt;</span><br><span class=\"line\">    &lt;value&gt;LAPTOP-1A91HHJ4:8088&lt;/value&gt;</span><br><span class=\"line\">&lt;/property&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>\n<h2 id=\"mapred-site\"><a class=\"markdownIt-Anchor\" href=\"#mapred-site\">#</a> mapred-site</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class=\"line\">&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;configuration.xsl&quot;?&gt;</span><br><span class=\"line\">&lt;!--</span><br><span class=\"line\">  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class=\"line\">  you may not use this file except in compliance with the License.</span><br><span class=\"line\">  You may obtain a copy of the License at</span><br><span class=\"line\"></span><br><span class=\"line\">    http://www.apache.org/licenses/LICENSE-2.0</span><br><span class=\"line\"></span><br><span class=\"line\">  Unless required by applicable law or agreed to in writing, software</span><br><span class=\"line\">  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class=\"line\">  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class=\"line\">  See the License for the specific language governing permissions and</span><br><span class=\"line\">  limitations under the License. See accompanying LICENSE file.</span><br><span class=\"line\">--&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!-- Put site-specific property overrides in this file. --&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;configuration&gt;</span><br><span class=\"line\">    &lt;!--</span><br><span class=\"line\">    &lt;property&gt;</span><br><span class=\"line\">    &lt;name&gt;mapreduce.framework.name&lt;/name&gt;</span><br><span class=\"line\">    &lt;value&gt;yarn&lt;/value&gt;</span><br><span class=\"line\">    &lt;/property&gt;--&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;property&gt;</span><br><span class=\"line\">      &lt;name&gt;mapreduce.job.tracker&lt;/name&gt;</span><br><span class=\"line\">      &lt;value&gt;hdfs://LAPTOP-1A91HHJ4:8001&lt;/value&gt;</span><br><span class=\"line\">      &lt;final&gt;true&lt;/final&gt;</span><br><span class=\"line\"> &lt;/property&gt;</span><br><span class=\"line\">&lt;property&gt;</span><br><span class=\"line\">        &lt;name&gt;mapreduce.jobhistory.address&lt;/name&gt;</span><br><span class=\"line\">        &lt;value&gt;LAPTOP-1A91HHJ4:10020&lt;/value&gt;</span><br><span class=\"line\">    &lt;/property&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;property&gt;</span><br><span class=\"line\">        &lt;name&gt;mapreduce.jobhistory.webapp.address&lt;/name&gt;</span><br><span class=\"line\">        &lt;value&gt;LAPTOP-1A91HHJ4:19888&lt;/value&gt;</span><br><span class=\"line\">    &lt;/property&gt;</span><br><span class=\"line\">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>\n<p>由于我走了很多的弯路，可能这上面的配置多了很多不必要的东西，但一定是可以跑通的。</p>\n<p>如果遇到了类似端口占用的报错请直接删除它，例如报错：Port in use:0.0.0.0:8042, 首先检查占用端口的进程：<br>\n‘netstat -ano | findstr :8042’<br>\n找到他的进程 ID，输入指令:'taskill /PID yourIdNum /F’即可</p>\n<h1 id=\"问题重述\"><a class=\"markdownIt-Anchor\" href=\"#问题重述\">#</a> 问题重述</h1>\n<p>一 实验目的<br>\n 1. 学习基于 MapReduce 框架的分布式计算程序设计方法。<br>\n2. 学习基于 Spark 框架的分布式计算程序设计方法。<br>\n二 实验题目<br>\n题目 1<br>\n 输入文件为学生成绩信息，包含了必修课与选修课成绩，格式如下：<br>\n班级 1, 姓名 1, 科目 1, 必修，成绩 1  <code>&lt;br&gt;</code>  （注： <code>&lt;br&gt;</code>  为换行符）<br>\n班级 2, 姓名 2, 科目 1, 必修，成绩 2  <code>&lt;br&gt;</code> <br>\n 班级 1, 姓名 1, 科目 2, 选修，成绩 3  <code>&lt;br&gt;</code> <br>\n………., ………, ………, ………    <code>&lt;br&gt;</code></p>\n<p>编写两个 Hadoop 平台上的 MapReduce 程序，分别实现如下功能：<br>\n1. 计算每个学生必修课的平均成绩。<br>\n2. 按科目统计每个班的平均成绩。<br>\n题目 2<br>\n 输入文件的每一行为具有父子 / 父女 / 母子 / 母女 / 关系的一对人名，例如：<br>\nTim, Andy  <code>&lt;br&gt;</code> <br>\nHarry, Alice  <code>&lt;br&gt;</code> <br>\nMark, Louis  <code>&lt;br&gt;</code> <br>\nAndy, Joseph  <code>&lt;br&gt;</code> <br>\n…………, …………  <code>&lt;br&gt;</code> <br>\n 假定不会出现重名现象。<br>\n编写 Hadoop 平台上的 MapReduce 程序，找出所有具有 grandchild-grandparent 关系的人名组。<br>\n题目 3<br>\n 输入文件为学生成绩信息，包含了必修课与选修课成绩，格式如下：<br>\n班级 1, 姓名 1, 科目 1, 必修，成绩 1  <code>&lt;br&gt;</code>  （注： <code>&lt;br&gt;</code>  为换行符）<br>\n班级 2, 姓名 2, 科目 1, 必修，成绩 2  <code>&lt;br&gt;</code> <br>\n 班级 1, 姓名 1, 科目 2, 选修，成绩 3  <code>&lt;br&gt;</code> <br>\n………., ………, ………, ………    <code>&lt;br&gt;</code> <br>\n 编写一个 Spark 程序，同时实现如下功能：</p>\n<ol>\n<li>计算每个学生必修课的平均成绩。</li>\n<li>统计学生必修课平均成绩在：'90<sub>100,80</sub>89,70<sub>79,60</sub>69 和 60 分以下’这 5 个分数段的人数。</li>\n</ol>\n<h1 id=\"具体实现\"><a class=\"markdownIt-Anchor\" href=\"#具体实现\">#</a> 具体实现</h1>\n<h2 id=\"题目1\"><a class=\"markdownIt-Anchor\" href=\"#题目1\">#</a> 题目 1</h2>\n<h3 id=\"问题1\"><a class=\"markdownIt-Anchor\" href=\"#问题1\">#</a> 问题 1</h3>\n<h4 id=\"配置pom\"><a class=\"markdownIt-Anchor\" href=\"#配置pom\">#</a> 配置 pom</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class=\"line\">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br><span class=\"line\">         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class=\"line\">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class=\"line\">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;groupId&gt;com.ls&lt;/groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;StuAvg&lt;/artifactId&gt;</span><br><span class=\"line\">    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;dependencies&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;org.apache.hadoop&lt;/groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;hadoop-client&lt;/artifactId&gt;</span><br><span class=\"line\">            &lt;version&gt;3.3.3&lt;/version&gt;</span><br><span class=\"line\">        &lt;/dependency&gt;</span><br><span class=\"line\">    &lt;/dependencies&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;properties&gt;</span><br><span class=\"line\">        &lt;maven.compiler.source&gt;22&lt;/maven.compiler.source&gt;</span><br><span class=\"line\">        &lt;maven.compiler.target&gt;22&lt;/maven.compiler.target&gt;</span><br><span class=\"line\">        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br><span class=\"line\">    &lt;/properties&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;build&gt;</span><br><span class=\"line\">        &lt;finalName&gt;StuAvg&lt;/finalName&gt;</span><br><span class=\"line\">    &lt;/build&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;/project&gt;</span><br></pre></td></tr></table></figure>\n<p>剩下的配置文件与之类似，不再赘述</p>\n<h4 id=\"代码\"><a class=\"markdownIt-Anchor\" href=\"#代码\">#</a> 代码</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">package com.ls;</span><br><span class=\"line\"></span><br><span class=\"line\">import org.apache.hadoop.conf.Configuration;</span><br><span class=\"line\">import org.apache.hadoop.fs.Path;</span><br><span class=\"line\">import org.apache.hadoop.io.DoubleWritable;</span><br><span class=\"line\">import org.apache.hadoop.io.LongWritable;</span><br><span class=\"line\">import org.apache.hadoop.io.Text;</span><br><span class=\"line\">import org.apache.hadoop.mapreduce.Job;</span><br><span class=\"line\">import org.apache.hadoop.mapreduce.Mapper;</span><br><span class=\"line\">import org.apache.hadoop.mapreduce.Reducer;</span><br><span class=\"line\">import org.apache.hadoop.mapreduce.lib.input.FileInputFormat;</span><br><span class=\"line\">import org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</span><br><span class=\"line\"></span><br><span class=\"line\">import java.io.IOException;</span><br><span class=\"line\"></span><br><span class=\"line\">public class StuAvg &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    public static class StuMap extends Mapper&lt;LongWritable, Text, Text, LongWritable&gt; &#123;</span><br><span class=\"line\">        @Override</span><br><span class=\"line\">        protected void map (LongWritable key, Text value, Context context) throws IOException, InterruptedException &#123;</span><br><span class=\"line\">            String line = value.toString();</span><br><span class=\"line\">            String[] field = line.split(&quot;,&quot;);</span><br><span class=\"line\">            if ( field.length == 5 &amp;&amp; field[3].equals(&quot;必修&quot;)) &#123;</span><br><span class=\"line\">                String Name = field[1] ;</span><br><span class=\"line\">                long score = Long.parseLong(field[4]);</span><br><span class=\"line\">                context.write(new Text(Name), new LongWritable(score));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public static class StuReduce extends Reducer&lt;Text, LongWritable, Text, DoubleWritable&gt; &#123;</span><br><span class=\"line\">        @Override</span><br><span class=\"line\">        protected void reduce(Text key, Iterable&lt;LongWritable&gt; values, Context context) throws IOException, InterruptedException &#123;</span><br><span class=\"line\">            long sum = 0;</span><br><span class=\"line\">            int count = 0;</span><br><span class=\"line\"></span><br><span class=\"line\">            for (LongWritable val : values) &#123;</span><br><span class=\"line\">                sum += val.get();</span><br><span class=\"line\">                count++;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            if (count &gt; 0) &#123;</span><br><span class=\"line\">                double average = (double) sum / (double) count;</span><br><span class=\"line\">                context.write(key, new DoubleWritable(average));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public static void main(String[] args) throws Exception &#123;</span><br><span class=\"line\">        Configuration conf = new Configuration();</span><br><span class=\"line\">        Job job = Job.getInstance(conf);</span><br><span class=\"line\">        job.setJarByClass(StuMap.class);</span><br><span class=\"line\">        job.setMapperClass(StuMap.class);</span><br><span class=\"line\">        job.setReducerClass(StuReduce.class);</span><br><span class=\"line\">        job.setMapOutputKeyClass(Text.class);</span><br><span class=\"line\">        job.setMapOutputValueClass(LongWritable.class);</span><br><span class=\"line\">        job.setOutputKeyClass(Text.class);</span><br><span class=\"line\">        job.setOutputValueClass(DoubleWritable.class);</span><br><span class=\"line\"></span><br><span class=\"line\">        FileInputFormat.setInputPaths(job, new Path(args[0]));</span><br><span class=\"line\">        FileOutputFormat.setOutputPath(job, new Path(args[1]));</span><br><span class=\"line\"></span><br><span class=\"line\">        System.exit(job.waitForCompletion(true) ? 0 : 1);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"问题2\"><a class=\"markdownIt-Anchor\" href=\"#问题2\">#</a> 问题 2</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">package com.ls;</span><br><span class=\"line\"></span><br><span class=\"line\">import org.apache.hadoop.conf.Configuration;</span><br><span class=\"line\">import org.apache.hadoop.fs.Path;</span><br><span class=\"line\">import org.apache.hadoop.io.DoubleWritable;</span><br><span class=\"line\">import org.apache.hadoop.io.LongWritable;</span><br><span class=\"line\">import org.apache.hadoop.io.Text;</span><br><span class=\"line\">import org.apache.hadoop.mapreduce.Job;</span><br><span class=\"line\">import org.apache.hadoop.mapreduce.Mapper;</span><br><span class=\"line\">import org.apache.hadoop.mapreduce.Reducer;</span><br><span class=\"line\">import org.apache.hadoop.mapreduce.lib.input.FileInputFormat;</span><br><span class=\"line\">import org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</span><br><span class=\"line\"></span><br><span class=\"line\">import java.io.IOException;</span><br><span class=\"line\"></span><br><span class=\"line\">public class ClassAvg &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    public static class Map extends Mapper&lt;LongWritable, Text, Text, LongWritable&gt; &#123;</span><br><span class=\"line\">        @Override</span><br><span class=\"line\">        protected void map (LongWritable key, Text value, Context context) throws IOException, InterruptedException &#123;</span><br><span class=\"line\">            String line = value.toString();</span><br><span class=\"line\">            String[] field = line.split(&quot;,&quot;);</span><br><span class=\"line\">            if ( field.length == 5 ) &#123;</span><br><span class=\"line\">                String Name = field[0]+&quot;_&quot;+field[2] ;</span><br><span class=\"line\">                long score = Long.parseLong(field[4]);</span><br><span class=\"line\">                context.write(new Text(Name), new LongWritable(score));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public static class Reduce extends Reducer&lt;Text, LongWritable, Text, DoubleWritable&gt; &#123;</span><br><span class=\"line\">        @Override</span><br><span class=\"line\">        protected void reduce(Text key, Iterable&lt;LongWritable&gt; values, Context context) throws IOException, InterruptedException &#123;</span><br><span class=\"line\">            long sum = 0;</span><br><span class=\"line\">            int count = 0;</span><br><span class=\"line\"></span><br><span class=\"line\">            for (LongWritable val : values) &#123;</span><br><span class=\"line\">                sum += val.get();</span><br><span class=\"line\">                count++ ;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            double average = (double) sum / (double) count;</span><br><span class=\"line\">            context.write(key, new DoubleWritable(average));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public static void main(String[] args) throws Exception &#123;</span><br><span class=\"line\">        Configuration conf = new Configuration();</span><br><span class=\"line\">        Job job = Job.getInstance(conf);</span><br><span class=\"line\">        job.setJarByClass(Map.class);</span><br><span class=\"line\">        job.setMapperClass(Map.class);</span><br><span class=\"line\">        job.setReducerClass(Reduce.class);</span><br><span class=\"line\">        job.setMapOutputKeyClass(Text.class);</span><br><span class=\"line\">        job.setMapOutputValueClass(LongWritable.class);</span><br><span class=\"line\">        job.setOutputKeyClass(Text.class);</span><br><span class=\"line\">        job.setOutputValueClass(DoubleWritable.class);</span><br><span class=\"line\"></span><br><span class=\"line\">        FileInputFormat.setInputPaths(job, new Path(args[0]));</span><br><span class=\"line\">        FileOutputFormat.setOutputPath(job, new Path(args[1]));</span><br><span class=\"line\"></span><br><span class=\"line\">        System.exit(job.waitForCompletion(true) ? 0 : 1);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"题目2\"><a class=\"markdownIt-Anchor\" href=\"#题目2\">#</a> 题目 2</h2>\n<h3 id=\"代码-2\"><a class=\"markdownIt-Anchor\" href=\"#代码-2\">#</a> 代码</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">package com.ls;</span><br><span class=\"line\">import org.apache.hadoop.conf.Configuration;</span><br><span class=\"line\">import org.apache.hadoop.fs.Path;</span><br><span class=\"line\">import org.apache.hadoop.io.DoubleWritable;</span><br><span class=\"line\">import org.apache.hadoop.io.LongWritable;</span><br><span class=\"line\">import org.apache.hadoop.io.Text;</span><br><span class=\"line\">import org.apache.hadoop.mapreduce.Job;</span><br><span class=\"line\">import org.apache.hadoop.mapreduce.Mapper;</span><br><span class=\"line\">import org.apache.hadoop.mapreduce.Reducer;</span><br><span class=\"line\">import org.apache.hadoop.mapreduce.lib.input.FileInputFormat;</span><br><span class=\"line\">import org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</span><br><span class=\"line\"></span><br><span class=\"line\">import java.io.IOException;</span><br><span class=\"line\">import java.util.ArrayList;</span><br><span class=\"line\">public class GrandPC &#123;</span><br><span class=\"line\">    public static class Map extends Mapper&lt;LongWritable, Text, Text, Text&gt; &#123;</span><br><span class=\"line\">        @Override</span><br><span class=\"line\">        protected void map (LongWritable key, Text value, Context context) throws IOException, InterruptedException &#123;</span><br><span class=\"line\">            String line = value.toString();</span><br><span class=\"line\">            String[] names = line.split(&quot;,&quot;);</span><br><span class=\"line\">            String child = names[0].trim()+&quot;_child&quot;;</span><br><span class=\"line\">            String grand = names[1].trim()+&quot;_parent&quot;;</span><br><span class=\"line\">            context.write(new Text(names[0].trim()), new Text(grand));</span><br><span class=\"line\">            context.write(new Text(names[1].trim()), new Text(child));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public static class Reduce extends Reducer&lt;Text, Text, Text, Text&gt; &#123;</span><br><span class=\"line\">        @Override</span><br><span class=\"line\">        protected void reduce (Text key, Iterable&lt;Text&gt; values, Context context) throws IOException, InterruptedException &#123;</span><br><span class=\"line\">            String grand = key.toString();</span><br><span class=\"line\">            ArrayList&lt;String&gt; parents = new ArrayList&lt;&gt;() ;</span><br><span class=\"line\">            ArrayList&lt;String&gt; children = new ArrayList&lt;&gt;() ;</span><br><span class=\"line\">            for (Text value : values) &#123;</span><br><span class=\"line\">                String node = value.toString();</span><br><span class=\"line\">                String [] name = node.split(&quot;_&quot;) ;</span><br><span class=\"line\">                if ( name[1].equals(&quot;child&quot;) ) &#123;</span><br><span class=\"line\">                    children.add(name[0].trim());</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                else if ( name[1].equals(&quot;parent&quot;) ) &#123;</span><br><span class=\"line\">                    parents.add(name[0].trim());</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                else &#123;</span><br><span class=\"line\">                    continue ;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            for (String child : children) &#123;</span><br><span class=\"line\">                for (String parent : parents) &#123;</span><br><span class=\"line\">                    context.write(new Text(child), new Text(parent));</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public static void main(String[] args) throws Exception &#123;</span><br><span class=\"line\">        Configuration conf = new Configuration();</span><br><span class=\"line\">        Job job = Job.getInstance(conf);</span><br><span class=\"line\">        job.setJarByClass(Map.class);</span><br><span class=\"line\">        job.setMapperClass(Map.class);</span><br><span class=\"line\">        job.setReducerClass(Reduce.class);</span><br><span class=\"line\">        job.setMapOutputKeyClass(Text.class);</span><br><span class=\"line\">        job.setMapOutputValueClass(Text.class);</span><br><span class=\"line\">        job.setOutputKeyClass(Text.class);</span><br><span class=\"line\">        job.setOutputValueClass(Text.class);</span><br><span class=\"line\"></span><br><span class=\"line\">        FileInputFormat.setInputPaths(job, new Path(args[0]));</span><br><span class=\"line\">        FileOutputFormat.setOutputPath(job, new Path(args[1]));</span><br><span class=\"line\"></span><br><span class=\"line\">        System.exit(job.waitForCompletion(true) ? 0 : 1);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"思路\"><a class=\"markdownIt-Anchor\" href=\"#思路\">#</a> 思路</h3>\n<p>思路是输入的数据例如 child,parent，我们将它变为两组输出，一组为 child,parentParent, 一组为 parent,childChild。在 map 阶段，若对于同一 KEY 有多个值，我们将值划分为 Parent 组和 Child 组一一匹配作为祖先 - 孩子组输出。</p>\n<h2 id=\"题目3\"><a class=\"markdownIt-Anchor\" href=\"#题目3\">#</a> 题目 3</h2>\n<h3 id=\"代码-3\"><a class=\"markdownIt-Anchor\" href=\"#代码-3\">#</a> 代码</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"># -*- coding: gb18030 -*-</span><br><span class=\"line\"></span><br><span class=\"line\">from pyspark import SparkConf, SparkContext</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">conf = SparkConf().setMaster(&quot;local&quot;).setAppName(&quot;gradecount&quot;)</span><br><span class=\"line\">sc = SparkContext(conf = conf)</span><br><span class=\"line\">grades = sc.textFile(&quot;/spark/grades.txt&quot;)</span><br><span class=\"line\"> </span><br><span class=\"line\">def f(x):</span><br><span class=\"line\">    if(x &gt;= 90 and x &lt;= 100):</span><br><span class=\"line\">        return (&quot;90-100&quot;)</span><br><span class=\"line\">    if(x &gt;= 80 and x &lt; 90):</span><br><span class=\"line\">        return (&quot;80-89&quot;) </span><br><span class=\"line\">    if(x &gt;= 70 and x &lt; 80):</span><br><span class=\"line\">        return (&quot;70-79&quot;) </span><br><span class=\"line\">    if(x &gt;= 60 and x &lt; 70):</span><br><span class=\"line\">        return (&quot;60-69&quot;) </span><br><span class=\"line\">    if(x &lt; 60):</span><br><span class=\"line\">        return (&quot;0-59&quot;) </span><br><span class=\"line\">grades = grades.filter(lambda line: &quot;必修&quot; in line)</span><br><span class=\"line\"></span><br><span class=\"line\">name_grade_pairs = grades.map(lambda line: (line.split(&quot;,&quot;)[1], (int(line.split(&quot;,&quot;)[4]), 1)))</span><br><span class=\"line\"># name_grade_pairs.saveAsTextFile(&quot;name_grade_pairs&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">avg_grades = name_grade_pairs.reduceByKey(lambda x1, x2: (x1[0] + x2[0], x1[1] + x2[1])).mapValues(lambda x: int(x[0] / x[1])).sortBy(lambda x: x[1], ascending=True)</span><br><span class=\"line\">avg_grades.saveAsTextFile(&quot;/avg_grades&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">interval_grades = avg_grades.map(lambda x: (f(x[1]), 1))</span><br><span class=\"line\">interval_stu_nums = interval_grades.reduceByKey(lambda x, y: (x + y)).sortByKey()</span><br><span class=\"line\">interval_stu_nums.saveAsTextFile(&quot;/interval_stu_nums&quot;)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h1 id=\"具体指令\"><a class=\"markdownIt-Anchor\" href=\"#具体指令\">#</a> 具体指令</h1>\n<h2 id=\"打开hadoop\"><a class=\"markdownIt-Anchor\" href=\"#打开hadoop\">#</a> 打开 hadoop</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">start-all</span><br></pre></td></tr></table></figure>\n<h2 id=\"stuavg\"><a class=\"markdownIt-Anchor\" href=\"#stuavg\">#</a> StuAvg</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mvn clean</span><br><span class=\"line\">mvn package</span><br><span class=\"line\"></span><br><span class=\"line\">hadoop fs -mkdir /StuAvg</span><br><span class=\"line\">hadoop fs -put grades.txt /StuAvg</span><br><span class=\"line\">hadoop jar ./target/StuAvg.jar com.ls.StuAvg /StuAvg/grades.txt /output1</span><br><span class=\"line\"></span><br><span class=\"line\">hadoop fs -ls /output1</span><br><span class=\"line\">hadoop fs -cat /output1/part-r-00000</span><br><span class=\"line\">hadoop fs -rm -r /output1</span><br></pre></td></tr></table></figure>\n<h2 id=\"classavg\"><a class=\"markdownIt-Anchor\" href=\"#classavg\">#</a> ClassAvg</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mvn clean</span><br><span class=\"line\">mvn package</span><br><span class=\"line\"></span><br><span class=\"line\">hadoop fs -mkdir /ClassAvg</span><br><span class=\"line\">hadoop fs -put grades.txt /ClassAvg</span><br><span class=\"line\">hadoop jar ./target/ClassAvg.jar com.ls.ClassAvg /ClassAvg/grades.txt /output2</span><br><span class=\"line\"></span><br><span class=\"line\">hadoop fs -ls /output2</span><br><span class=\"line\">hadoop fs -cat /output2/part-r-00000</span><br><span class=\"line\">hadoop fs -rm -r /output2</span><br></pre></td></tr></table></figure>\n<h2 id=\"grandpc\"><a class=\"markdownIt-Anchor\" href=\"#grandpc\">#</a> GrandPC</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mvn clean</span><br><span class=\"line\">mvn package</span><br><span class=\"line\"></span><br><span class=\"line\">hadoop fs -mkdir /GrandPC</span><br><span class=\"line\">hadoop fs -put child-parent.txt /GrandPC</span><br><span class=\"line\">hadoop jar ./target/GrandPC.jar com.ls.GrandPC /GrandPC/child-parent.txt /output3</span><br><span class=\"line\"></span><br><span class=\"line\">hadoop fs -ls /output3</span><br><span class=\"line\">hadoop fs -cat /output3/part-r-00000</span><br><span class=\"line\">hadoop fs -rm -r /output3</span><br></pre></td></tr></table></figure>\n<h2 id=\"spark\"><a class=\"markdownIt-Anchor\" href=\"#spark\">#</a> Spark</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">start-dfs </span><br><span class=\"line\"></span><br><span class=\"line\">hadoop fs -mkdir /spark</span><br><span class=\"line\">hadoop fs -put C:\\Users\\11523\\Desktop\\Spark\\grades.txt /spark</span><br><span class=\"line\"></span><br><span class=\"line\">pyspark</span><br><span class=\"line\"></span><br><span class=\"line\">spark-submit Spark.py</span><br><span class=\"line\"></span><br><span class=\"line\">hadoop fs -cat /interval_stu_nums/part-00000</span><br><span class=\"line\">hadoop fs -cat /avg_grades/part-00000</span><br></pre></td></tr></table></figure>\n<h1 id=\"实际效果\"><a class=\"markdownIt-Anchor\" href=\"#实际效果\">#</a> 实际效果</h1>\n<h2 id=\"stuavg-2\"><a class=\"markdownIt-Anchor\" href=\"#stuavg-2\">#</a> StuAvg</h2>\n<p><img data-src=\"2.png\" alt=\"\"></p>\n<h2 id=\"classavg-2\"><a class=\"markdownIt-Anchor\" href=\"#classavg-2\">#</a> ClassAvg</h2>\n<p><img data-src=\"3.png\" alt=\"\"></p>\n<h2 id=\"grandpc-2\"><a class=\"markdownIt-Anchor\" href=\"#grandpc-2\">#</a> GrandPC</h2>\n<p><img data-src=\"4.png\" alt=\"\"></p>\n<h2 id=\"spark-2\"><a class=\"markdownIt-Anchor\" href=\"#spark-2\">#</a> Spark</h2>\n<p><img data-src=\"5.png\" alt=\"\"><br>\n<img data-src=\"6.png\" alt=\"\"></p>\n",
            "tags": [
                "代码",
                "分布式"
            ]
        },
        {
            "id": "http://amentiraz.github.io/2024/06/03/P2P%E7%BE%A4%E8%81%8A%E7%B3%BB%E7%BB%9F/",
            "url": "http://amentiraz.github.io/2024/06/03/P2P%E7%BE%A4%E8%81%8A%E7%B3%BB%E7%BB%9F/",
            "title": "P2P群聊系统",
            "date_published": "2024-06-03T02:39:18.000Z",
            "content_html": "<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>分布式作业</p>\n<span id=\"more\"></span>\n<h1 id=\"问题重述\"><a class=\"markdownIt-Anchor\" href=\"#问题重述\">#</a> 问题重述</h1>\n<p><img data-src=\"1.png\" alt=\"\"></p>\n<h1 id=\"实验原理\"><a class=\"markdownIt-Anchor\" href=\"#实验原理\">#</a> 实验原理</h1>\n<h2 id=\"全序广播协议\"><a class=\"markdownIt-Anchor\" href=\"#全序广播协议\">#</a> 全序广播协议</h2>\n<p><img data-src=\"2.png\" alt=\"\"></p>\n<p>采用一个服务端，多个客户端的方法，当客户端收到服务端传来的信息时，判断该信息属于 ACK 信息、新加入客户端信息还是 message 消息。</p>\n<p>如果这条信息是属于 ACK 信息，将对应消息 m 的 ACK+1, 观察队列头部的消息，如果关于该消息已经收到了所有节点的 ACK 消息，则将其从队列中取出，并完成投递。</p>\n<p>如果这条信息属于发送的信息，将消息按逻辑时间戳先后顺序放入缓存队列，观察缓存队列头部的消息，如果该消息尚未广播过 ACK 消息，则向所有节点发送关于该消息的 ACK 信息.</p>\n<p>具体实现如下图代码所示</p>\n<p><img data-src=\"3.png\" alt=\"\"></p>\n<h2 id=\"因果关系\"><a class=\"markdownIt-Anchor\" href=\"#因果关系\">#</a> 因果关系</h2>\n<p><img data-src=\"4.png\" alt=\"\"></p>\n<p>当客户端收到一条消息就将自己的时间戳与该信息的时间戳相比较，更新为更大的值实现因果关系的同一。</p>\n<p>具体实现如下<br>\n<img data-src=\"5.png\" alt=\"\"></p>\n<h2 id=\"传递消息\"><a class=\"markdownIt-Anchor\" href=\"#传递消息\">#</a> 传递消息</h2>\n<p>采用 socket 传递消息</p>\n<h2 id=\"雪花算法\"><a class=\"markdownIt-Anchor\" href=\"#雪花算法\">#</a> 雪花算法</h2>\n<p><img data-src=\"6.png\" alt=\"\"></p>\n<p>为 Server 提供信息的 ID 号</p>\n<h1 id=\"实验环境\"><a class=\"markdownIt-Anchor\" href=\"#实验环境\">#</a> 实验环境</h1>\n<h2 id=\"软件版本\"><a class=\"markdownIt-Anchor\" href=\"#软件版本\">#</a> 软件版本</h2>\n<p>Windows11<br>\nEclipse IDE for Java Developers - 2022-03<br>\nJava 1.8<br>\nMaven3.6.1<br>\nGson2.8.5</p>\n<p><img data-src=\"7.png\" alt=\"\"></p>\n<h2 id=\"pom环境\"><a class=\"markdownIt-Anchor\" href=\"#pom环境\">#</a> pom 环境</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class=\"line\">  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class=\"line\">  &lt;groupId&gt;com.ls&lt;/groupId&gt;</span><br><span class=\"line\">  &lt;artifactId&gt;p2psystem&lt;/artifactId&gt;</span><br><span class=\"line\">  &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class=\"line\">  </span><br><span class=\"line\">  &lt;dependencies&gt;</span><br><span class=\"line\">  </span><br><span class=\"line\">  \t&lt;dependency&gt;</span><br><span class=\"line\">    \t&lt;groupId&gt;com.google.code.gson&lt;/groupId&gt;</span><br><span class=\"line\">    \t&lt;artifactId&gt;gson&lt;/artifactId&gt;</span><br><span class=\"line\">    \t&lt;version&gt;2.8.5&lt;/version&gt;</span><br><span class=\"line\">  \t&lt;/dependency&gt;</span><br><span class=\"line\">  \t</span><br><span class=\"line\">  \t&lt;dependency&gt;</span><br><span class=\"line\">    \t&lt;groupId&gt;org.glassfish.tyrus.bundles&lt;/groupId&gt;</span><br><span class=\"line\">    \t&lt;artifactId&gt;tyrus-standalone-client&lt;/artifactId&gt;</span><br><span class=\"line\">    \t&lt;version&gt;1.18&lt;/version&gt;</span><br><span class=\"line\">\t&lt;/dependency&gt;</span><br><span class=\"line\">  \t</span><br><span class=\"line\">  \t</span><br><span class=\"line\">  &lt;/dependencies&gt;</span><br><span class=\"line\">  </span><br><span class=\"line\">  </span><br><span class=\"line\">&lt;/project&gt;</span><br></pre></td></tr></table></figure>\n<h1 id=\"设计思路\"><a class=\"markdownIt-Anchor\" href=\"#设计思路\">#</a> 设计思路</h1>\n<h2 id=\"构架图\"><a class=\"markdownIt-Anchor\" href=\"#构架图\">#</a> 构架图</h2>\n<p><img data-src=\"8.jpg\" alt=\"\"></p>\n<h2 id=\"各个代码的用途\"><a class=\"markdownIt-Anchor\" href=\"#各个代码的用途\">#</a> 各个代码的用途</h2>\n<h3 id=\"client\"><a class=\"markdownIt-Anchor\" href=\"#client\">#</a> Client</h3>\n<p>接受服务端的信息，处理终端和前端 UI 的信息，将最终信息传递给 TextSaverApp 进行展示。</p>\n<h3 id=\"server\"><a class=\"markdownIt-Anchor\" href=\"#server\">#</a> Server</h3>\n<p>不断接收来自 PORT 端口的信息，并将信息传给所有的 Client 节点，值得主义的是由于 messageID 是唯一的，所以需要进行锁操作，我采用了 Java 中的 synchronized 函数对此变量进行锁操作。</p>\n<h3 id=\"textsaverapp\"><a class=\"markdownIt-Anchor\" href=\"#textsaverapp\">#</a> TextSaverAPP</h3>\n<p>对文本框接收到的信息进行处理并传递给 Server 服务器；对从 Client 收到的信息进行展示。</p>\n<h3 id=\"messageutilsmessage\"><a class=\"markdownIt-Anchor\" href=\"#messageutilsmessage\">#</a> MessageUtils\\Message</h3>\n<p>对信息进行定义并执行序列化和反序列化操作</p>\n<h3 id=\"messagequeue\"><a class=\"markdownIt-Anchor\" href=\"#messagequeue\">#</a> MessageQueue</h3>\n<p>对信息进行存储、删除、记录次数操作，并利用优先队列对信息进行排序。</p>\n<h3 id=\"snowflakeidgenerator\"><a class=\"markdownIt-Anchor\" href=\"#snowflakeidgenerator\">#</a> SnowflakeIdGenerator</h3>\n<p>生成信息的 ID 号</p>\n<h1 id=\"commands\"><a class=\"markdownIt-Anchor\" href=\"#commands\">#</a> Commands</h1>\n<p>mvn clean<br>\nmvn compile</p>\n<p>mvn exec:java -Dexec.mainClass=“p2psystem.Server”</p>\n<p>mvn exec:java -Dexec.mainClass=“p2psystem.Client”</p>\n<h1 id=\"java程序\"><a class=\"markdownIt-Anchor\" href=\"#java程序\">#</a> JAVA 程序</h1>\n<h2 id=\"clientjava\"><a class=\"markdownIt-Anchor\" href=\"#clientjava\">#</a> Client.java</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">package</span> p2psystem;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.* ;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.Socket;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.google.gson.Gson; </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Client</span> &#123;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">String</span> <span class=\"variable\">SEVERADDRESS</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;127.0.0.1&quot;</span> ; </span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">PORT</span> <span class=\"operator\">=</span> <span class=\"number\">8189</span> ; </span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"type\">int</span> <span class=\"variable\">clientNum</span> <span class=\"operator\">=</span> <span class=\"number\">1</span> ; </span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"type\">int</span> <span class=\"variable\">logicNum</span> <span class=\"operator\">=</span> <span class=\"number\">1</span> ; </span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">Gson</span> <span class=\"variable\">gson</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Gson</span>() ;</span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">ACKseq</span> <span class=\"operator\">=</span> <span class=\"number\">1145141919</span> ; </span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">ACKnew</span> <span class=\"operator\">=</span> <span class=\"number\">1919810</span> ; </span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">MessageQueue</span> <span class=\"variable\">Mqueue</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MessageQueue</span> ( ) ; </span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"type\">TextSaverApp</span> <span class=\"variable\">chat</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">TextSaverApp</span>(<span class=\"string\">&quot;chatgroup&quot;</span>) ; </span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"type\">int</span> ClientName ;</span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"type\">int</span> <span class=\"variable\">ACKname</span> <span class=\"operator\">=</span> <span class=\"number\">0</span> ; </span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span> <span class=\"params\">( String [] args )</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// 定义socket,输入输出变量</span></span><br><span class=\"line\">\t\t<span class=\"type\">Socket</span> <span class=\"variable\">socket</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Socket</span> ( SEVERADDRESS , PORT ) ; </span><br><span class=\"line\">\t\t<span class=\"type\">BufferedReader</span> <span class=\"variable\">in</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">BufferedReader</span> ( <span class=\"keyword\">new</span> <span class=\"title class_\">InputStreamReader</span> ( socket.getInputStream() ) ) ; </span><br><span class=\"line\">\t\t<span class=\"type\">PrintWriter</span> <span class=\"variable\">out</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">PrintWriter</span> ( socket.getOutputStream() , <span class=\"literal\">true</span> ) ; </span><br><span class=\"line\">\t\t<span class=\"type\">BufferedReader</span> <span class=\"variable\">consoleInput</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">BufferedReader</span> ( <span class=\"keyword\">new</span> <span class=\"title class_\">InputStreamReader</span> ( System.in ) ) ; </span><br><span class=\"line\">\t\t<span class=\"comment\">// 创造一个不断接受服务端信息的进程</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">new</span> <span class=\"title class_\">Thread</span> ( ( ) -&gt; &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\t\tString serverMessageJson ; </span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">while</span> ( ( serverMessageJson = in.readLine() ) != <span class=\"literal\">null</span> ) &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"type\">Message</span> <span class=\"variable\">message</span> <span class=\"operator\">=</span> MessageUtils.deserialize(serverMessageJson) ; </span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// 如果这条信息是属于ACK信息</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// 将对应消息m的ACK+1</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// 观察队列头部的消息，如果关于该消息已经收到了所有节点的ACK消息，则将其从队列中取出，并完成投递</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> ( message.getseq() == ACKseq ) &#123;</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"comment\">//Mqueue.printAllMessages();</span></span><br><span class=\"line\">\t\t\t\t\t\tMqueue.incrementIdCount(message) ; </span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"type\">Message</span> <span class=\"variable\">HeadMessage</span> <span class=\"operator\">=</span> Mqueue.getHeadMessage() ; </span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"type\">int</span> <span class=\"variable\">count</span> <span class=\"operator\">=</span> Mqueue.getMessageCount(HeadMessage.getId()) ; </span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">if</span> ( count == clientNum ) &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\tlogicNum = logicNum + <span class=\"number\">1</span> ; </span><br><span class=\"line\">\t\t\t\t\t\t\tchat.setLogicNum(logicNum) ;</span><br><span class=\"line\">\t\t\t\t\t\t\tMqueue.removeMessage(HeadMessage.getId()) ; </span><br><span class=\"line\">\t\t\t\t\t\t\t<span class=\"comment\">//传递给应用层</span></span><br><span class=\"line\">\t\t\t\t\t\t\tchat.appendText(ClientName + <span class=\"string\">&quot;:&quot;</span> + HeadMessage.toString());</span><br><span class=\"line\">\t\t\t\t\t\t\tSystem.out.println ( HeadMessage.toString() ) ; </span><br><span class=\"line\">\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// 处理新来的客户端</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( message.getseq() == ACKnew ) &#123;</span><br><span class=\"line\">\t\t\t\t\t\tlogicNum = logicNum + <span class=\"number\">1</span> ; </span><br><span class=\"line\">\t\t\t\t\t\tchat.setLogicNum(logicNum) ;</span><br><span class=\"line\">\t\t\t\t\t\tclientNum = (<span class=\"type\">int</span>)message.getId() ; </span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">if</span> ( ACKname == <span class=\"number\">0</span> ) &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\tACKname = <span class=\"number\">1</span> ; </span><br><span class=\"line\">\t\t\t\t\t\t\tClientName = clientNum ; </span><br><span class=\"line\">\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\tSystem.out.println ( clientNum ) ; </span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// 如果这条信息属于发送的信息</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// 将消息按逻辑时间戳先后顺序放入缓存队列</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// 观察缓存队列头部的消息，如果该消息尚未广播过ACK消息，则向所有节点发送关于该消息的ACK信息</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">else</span> &#123; </span><br><span class=\"line\">\t\t\t\t\t\tMqueue.addMessage(message) ;</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"comment\">//Mqueue.printAllMessages();</span></span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"comment\">//System.out.println(message.toString());</span></span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"type\">Message</span> <span class=\"variable\">HeadMessage</span> <span class=\"operator\">=</span> Mqueue.getHeadMessage() ; </span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"type\">int</span> <span class=\"variable\">count</span> <span class=\"operator\">=</span> Mqueue.getBroadCount(HeadMessage.getId()) ;</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"comment\">//System.out.println ( count ) ; </span></span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">if</span> ( count == <span class=\"number\">0</span> ) &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\t<span class=\"comment\">// 发送ACK信息</span></span><br><span class=\"line\">\t\t\t\t\t\t\tMqueue.incrementBroadCount(message) ; </span><br><span class=\"line\">\t\t\t\t\t\t\t<span class=\"type\">Message</span> <span class=\"variable\">Hmessage</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Message</span> ( message.getId() , ACKseq , message.getContent() )  ; </span><br><span class=\"line\">\t\t\t\t\t\t\t<span class=\"type\">String</span> <span class=\"variable\">messageJson</span> <span class=\"operator\">=</span> MessageUtils.serialize(Hmessage) ; </span><br><span class=\"line\">\t\t\t\t\t\t\tlogicNum = Math.max(logicNum, message.getseq()) ; </span><br><span class=\"line\">\t\t\t\t\t\t\tlogicNum = logicNum + <span class=\"number\">1</span> ; </span><br><span class=\"line\">\t\t\t\t\t\t\tchat.setLogicNum(logicNum) ; </span><br><span class=\"line\">\t\t\t\t\t\t\tout.println(messageJson);</span><br><span class=\"line\">\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125; <span class=\"keyword\">catch</span> ( IOException e ) &#123;</span><br><span class=\"line\">\t\t\t\te.printStackTrace() ; </span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;).start ( ) ; </span><br><span class=\"line\">\t\t<span class=\"comment\">// 告诉服务器有新客户端加入</span></span><br><span class=\"line\">\t\t<span class=\"type\">Message</span> <span class=\"variable\">infoM</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Message</span>( <span class=\"number\">0</span> , ACKnew , <span class=\"string\">&quot;Hello&quot;</span>) ;</span><br><span class=\"line\">\t\t<span class=\"type\">String</span> <span class=\"variable\">messageJso</span> <span class=\"operator\">=</span> MessageUtils.serialize(infoM) ; </span><br><span class=\"line\">\t\tout.println ( messageJso ) ; </span><br><span class=\"line\">\t\t<span class=\"comment\">// 对面板输入的数据处理</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// 对终端输入的数据进行处理</span></span><br><span class=\"line\">\t\tString userInput ; </span><br><span class=\"line\">\t\t<span class=\"keyword\">while</span> ( (userInput = consoleInput.readLine()) != <span class=\"literal\">null</span> ) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"type\">Message</span> <span class=\"variable\">message</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Message</span> ( <span class=\"number\">0</span> , logicNum , userInput ) ;</span><br><span class=\"line\">\t\t\t<span class=\"type\">String</span> <span class=\"variable\">messageJson</span> <span class=\"operator\">=</span> MessageUtils.serialize(message) ; </span><br><span class=\"line\">\t\t\tlogicNum = logicNum + <span class=\"number\">1</span> ; </span><br><span class=\"line\">\t\t\tchat.setLogicNum(logicNum) ;</span><br><span class=\"line\">\t\t\tout.println(messageJson);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"serverjava\"><a class=\"markdownIt-Anchor\" href=\"#serverjava\">#</a> Server.java</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">package</span> p2psystem;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.* ; </span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.* ; </span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.* ;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.google.gson.Gson; </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Server</span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// 定义需要的全局变量</span></span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">PORT</span> <span class=\"operator\">=</span> <span class=\"number\">8189</span> ; </span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"type\">int</span> <span class=\"variable\">messageID</span> <span class=\"operator\">=</span> <span class=\"number\">0</span> ; </span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> Map&lt;Integer,PrintWriter&gt; clientWriters = <span class=\"keyword\">new</span> <span class=\"title class_\">ConcurrentHashMap</span>&lt;&gt;() ; </span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">Gson</span> <span class=\"variable\">gson</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Gson</span>() ; </span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">SnowflakeIdGenerator</span> <span class=\"variable\">idGenerator</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">SnowflakeIdGenerator</span> ( <span class=\"number\">1</span> , <span class=\"number\">1</span> ) ;</span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">ACKseq</span> <span class=\"operator\">=</span> <span class=\"number\">1145141919</span> ;</span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">ACKnew</span> <span class=\"operator\">=</span> <span class=\"number\">1919810</span> ;</span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"type\">int</span> <span class=\"variable\">clientNum</span> <span class=\"operator\">=</span> <span class=\"number\">0</span> ;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span> <span class=\"params\">( String[] args )</span> &#123;</span><br><span class=\"line\">\t\tSystem.out.println ( <span class=\"string\">&quot;Central server started!&quot;</span>) ; </span><br><span class=\"line\">\t\t<span class=\"keyword\">try</span> ( <span class=\"type\">ServerSocket</span> <span class=\"variable\">serverSocket</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ServerSocket</span> ( PORT ) ) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"type\">int</span> <span class=\"variable\">count</span> <span class=\"operator\">=</span> <span class=\"number\">0</span> ; </span><br><span class=\"line\">\t\t\t<span class=\"keyword\">while</span> ( <span class=\"literal\">true</span> ) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">new</span> <span class=\"title class_\">ClientHandler</span>( serverSocket.accept() ).start() ; </span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> ( IOException e ) &#123;</span><br><span class=\"line\">\t\t\te.printStackTrace(); </span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ClientHandler</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">Thread</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">private</span> Socket socket ; </span><br><span class=\"line\">\t\t<span class=\"keyword\">private</span> <span class=\"type\">int</span> clientID ; </span><br><span class=\"line\">\t\t<span class=\"keyword\">private</span> BufferedReader in ; </span><br><span class=\"line\">\t\t<span class=\"keyword\">private</span> PrintWriter out ; </span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t<span class=\"keyword\">public</span> <span class=\"title function_\">ClientHandler</span> <span class=\"params\">( Socket socket )</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">this</span>.socket = socket ; </span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t<span class=\"meta\">@Override</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">run</span> <span class=\"params\">( )</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"type\">BufferedReader</span> <span class=\"variable\">in</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">BufferedReader</span> ( <span class=\"keyword\">new</span> <span class=\"title class_\">InputStreamReader</span> ( socket.getInputStream() ) ) ; </span><br><span class=\"line\">\t\t\t\t<span class=\"type\">PrintWriter</span> <span class=\"variable\">out</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">PrintWriter</span> ( socket.getOutputStream() , <span class=\"literal\">true</span> ) ; </span><br><span class=\"line\">\t\t\t\tclientID = socket.getPort() ; </span><br><span class=\"line\">\t\t\t\tclientWriters.put(clientID, out) ; </span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">\t\t\t\tString messageJson ; </span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">while</span> ( (messageJson = in.readLine()) != <span class=\"literal\">null</span> ) &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// synchronized用来锁这个相同同步块的线程，因为messageID时唯一的，只能有一个来进行写操作</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">synchronized</span> ( Server.class ) &#123;</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"type\">Message</span> <span class=\"variable\">message</span> <span class=\"operator\">=</span> MessageUtils.deserialize(messageJson);</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">if</span> ( message.getId() == <span class=\"number\">0</span> )</span><br><span class=\"line\">\t\t\t\t\t\t\tmessage.setId ( idGenerator.nextId() ) ; </span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">if</span> ( message.getseq() == ACKnew ) &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\tmessage.setId((<span class=\"type\">long</span>)clientNum+(<span class=\"type\">long</span>)<span class=\"number\">1</span>);</span><br><span class=\"line\">\t\t\t\t\t\t\tclientNum = clientNum + <span class=\"number\">1</span> ; </span><br><span class=\"line\">\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"type\">String</span> <span class=\"variable\">broadcastMessage</span> <span class=\"operator\">=</span> MessageUtils.serialize(message) ; </span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">for</span> ( PrintWriter writer : clientWriters.values() ) &#123;</span><br><span class=\"line\">\t\t\t\t\t\t\twriter.println ( broadcastMessage ) ; </span><br><span class=\"line\">\t\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125; <span class=\"keyword\">catch</span> ( IOException e ) &#123;</span><br><span class=\"line\">\t\t\t\te.printStackTrace(); </span><br><span class=\"line\">\t\t\t&#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> ( out != <span class=\"literal\">null</span> ) &#123;</span><br><span class=\"line\">\t\t\t\t\tclientWriters.remove(clientID) ; </span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\t\t\tsocket.close(); </span><br><span class=\"line\">\t\t\t\t&#125; <span class=\"keyword\">catch</span> ( IOException e ) &#123;</span><br><span class=\"line\">\t\t\t\t\te.printStackTrace();</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"snowflakeldgeneratorjava\"><a class=\"markdownIt-Anchor\" href=\"#snowflakeldgeneratorjava\">#</a> SnowflakeldGenerator.java</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">package</span> p2psystem;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">SnowflakeIdGenerator</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"type\">long</span> workerId;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"type\">long</span> datacenterId;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">twepoch</span> <span class=\"operator\">=</span> <span class=\"number\">1288834974657L</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">workerIdBits</span> <span class=\"operator\">=</span> <span class=\"number\">5L</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">datacenterIdBits</span> <span class=\"operator\">=</span> <span class=\"number\">5L</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">maxWorkerId</span> <span class=\"operator\">=</span> -<span class=\"number\">1L</span> ^ (-<span class=\"number\">1L</span> &lt;&lt; workerIdBits);</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">maxDatacenterId</span> <span class=\"operator\">=</span> -<span class=\"number\">1L</span> ^ (-<span class=\"number\">1L</span> &lt;&lt; datacenterIdBits);</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">sequenceBits</span> <span class=\"operator\">=</span> <span class=\"number\">12L</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">workerIdShift</span> <span class=\"operator\">=</span> sequenceBits;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">datacenterIdShift</span> <span class=\"operator\">=</span> sequenceBits + workerIdBits;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">timestampLeftShift</span> <span class=\"operator\">=</span> sequenceBits + workerIdBits + datacenterIdBits;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">sequenceMask</span> <span class=\"operator\">=</span> -<span class=\"number\">1L</span> ^ (-<span class=\"number\">1L</span> &lt;&lt; sequenceBits);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">long</span> <span class=\"variable\">lastTimestamp</span> <span class=\"operator\">=</span> -<span class=\"number\">1L</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">long</span> <span class=\"variable\">sequence</span> <span class=\"operator\">=</span> <span class=\"number\">0L</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">SnowflakeIdGenerator</span><span class=\"params\">(<span class=\"type\">long</span> workerId, <span class=\"type\">long</span> datacenterId)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (workerId &gt; maxWorkerId || workerId &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>(String.format(<span class=\"string\">&quot;worker Id can&#x27;t be greater than %d or less than 0&quot;</span>, maxWorkerId));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (datacenterId &gt; maxDatacenterId || datacenterId &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>(String.format(<span class=\"string\">&quot;datacenter Id can&#x27;t be greater than %d or less than 0&quot;</span>, maxDatacenterId));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.workerId = workerId;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.datacenterId = datacenterId;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">synchronized</span> <span class=\"type\">long</span> <span class=\"title function_\">nextId</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"type\">long</span> <span class=\"variable\">timestamp</span> <span class=\"operator\">=</span> timeGen();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (timestamp &lt; lastTimestamp) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RuntimeException</span>(String.format(<span class=\"string\">&quot;Clock moved backwards. Refusing to generate id for %d milliseconds&quot;</span>, lastTimestamp - timestamp));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (lastTimestamp == timestamp) &#123;</span><br><span class=\"line\">            sequence = (sequence + <span class=\"number\">1</span>) &amp; sequenceMask;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (sequence == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                timestamp = tilNextMillis(lastTimestamp);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            sequence = <span class=\"number\">0L</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        lastTimestamp = timestamp;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> ((timestamp - twepoch) &lt;&lt; timestampLeftShift) |</span><br><span class=\"line\">                (datacenterId &lt;&lt; datacenterIdShift) |</span><br><span class=\"line\">                (workerId &lt;&lt; workerIdShift) |</span><br><span class=\"line\">                sequence;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"type\">long</span> <span class=\"title function_\">tilNextMillis</span><span class=\"params\">(<span class=\"type\">long</span> lastTimestamp)</span> &#123;</span><br><span class=\"line\">        <span class=\"type\">long</span> <span class=\"variable\">timestamp</span> <span class=\"operator\">=</span> timeGen();</span><br><span class=\"line\">        <span class=\"keyword\">while</span> (timestamp &lt;= lastTimestamp) &#123;</span><br><span class=\"line\">            timestamp = timeGen();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> timestamp;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"type\">long</span> <span class=\"title function_\">timeGen</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> System.currentTimeMillis();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"textsaverapp-2\"><a class=\"markdownIt-Anchor\" href=\"#textsaverapp-2\">#</a> TextSaverApp</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">package</span> p2psystem;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.swing.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.awt.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.awt.event.ActionEvent;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.awt.event.ActionListener;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.BufferedReader;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.BufferedWriter;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.FileWriter;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.IOException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.InputStreamReader;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.PrintWriter;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.Socket;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.UnknownHostException;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">TextSaverApp</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> JFrame frame;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> JTextArea textArea;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> JTextField textField;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> JButton sendButton;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> BufferedWriter writer;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">String</span> <span class=\"variable\">SEVERADDRESS</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;127.0.0.1&quot;</span> ; </span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">int</span> <span class=\"variable\">PORT</span> <span class=\"operator\">=</span> <span class=\"number\">8189</span> ;</span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"type\">int</span> <span class=\"variable\">logicNum</span> <span class=\"operator\">=</span> <span class=\"number\">1</span> ;</span><br><span class=\"line\">\tSocket socket ;</span><br><span class=\"line\">\tBufferedReader in ; </span><br><span class=\"line\">\tPrintWriter out ; </span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">setLogicNum</span> <span class=\"params\">( <span class=\"type\">int</span> logicNum )</span> &#123; </span><br><span class=\"line\">\t\t<span class=\"built_in\">this</span>.logicNum = logicNum ; </span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">TextSaverApp</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        setupUI();</span><br><span class=\"line\">        setupWriter(<span class=\"string\">&quot;output.txt&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        \tsocket = <span class=\"keyword\">new</span> <span class=\"title class_\">Socket</span> ( SEVERADDRESS , PORT ) ; </span><br><span class=\"line\">        \tin = <span class=\"keyword\">new</span> <span class=\"title class_\">BufferedReader</span> ( <span class=\"keyword\">new</span> <span class=\"title class_\">InputStreamReader</span> ( socket.getInputStream() ) ) ; </span><br><span class=\"line\">        \tout = <span class=\"keyword\">new</span> <span class=\"title class_\">PrintWriter</span> ( socket.getOutputStream() , <span class=\"literal\">true</span> ) ; </span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> ( IOException e ) &#123;</span><br><span class=\"line\">        \te.getStackTrace() ; </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">TextSaverApp</span><span class=\"params\">(String filePath)</span> &#123;</span><br><span class=\"line\">        setupUI();</span><br><span class=\"line\">        setupWriter(filePath);</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        \tsocket = <span class=\"keyword\">new</span> <span class=\"title class_\">Socket</span> ( SEVERADDRESS , PORT ) ; </span><br><span class=\"line\">        \tin = <span class=\"keyword\">new</span> <span class=\"title class_\">BufferedReader</span> ( <span class=\"keyword\">new</span> <span class=\"title class_\">InputStreamReader</span> ( socket.getInputStream() ) ) ; </span><br><span class=\"line\">        \tout = <span class=\"keyword\">new</span> <span class=\"title class_\">PrintWriter</span> ( socket.getOutputStream() , <span class=\"literal\">true</span> ) ; </span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> ( IOException e ) &#123;</span><br><span class=\"line\">        \te.getStackTrace() ; </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">setupUI</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        frame = <span class=\"keyword\">new</span> <span class=\"title class_\">JFrame</span>(<span class=\"string\">&quot;Text Saver&quot;</span>);</span><br><span class=\"line\">        textArea = <span class=\"keyword\">new</span> <span class=\"title class_\">JTextArea</span>(<span class=\"number\">20</span>, <span class=\"number\">50</span>);</span><br><span class=\"line\">        textField = <span class=\"keyword\">new</span> <span class=\"title class_\">JTextField</span>(<span class=\"number\">40</span>);</span><br><span class=\"line\">        sendButton = <span class=\"keyword\">new</span> <span class=\"title class_\">JButton</span>(<span class=\"string\">&quot;Send&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        textArea.setEditable(<span class=\"literal\">false</span>);</span><br><span class=\"line\">        <span class=\"type\">JPanel</span> <span class=\"variable\">panel</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">JPanel</span>();</span><br><span class=\"line\">        panel.setLayout(<span class=\"keyword\">new</span> <span class=\"title class_\">BorderLayout</span>());</span><br><span class=\"line\">        panel.add(<span class=\"keyword\">new</span> <span class=\"title class_\">JScrollPane</span>(textArea), BorderLayout.CENTER);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">JPanel</span> <span class=\"variable\">inputPanel</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">JPanel</span>();</span><br><span class=\"line\">        inputPanel.add(textField);</span><br><span class=\"line\">        inputPanel.add(sendButton);</span><br><span class=\"line\"></span><br><span class=\"line\">        frame.getContentPane().add(panel, BorderLayout.CENTER);</span><br><span class=\"line\">        frame.getContentPane().add(inputPanel, BorderLayout.SOUTH);</span><br><span class=\"line\"></span><br><span class=\"line\">        sendButton.addActionListener(<span class=\"keyword\">new</span> <span class=\"title class_\">ActionListener</span>() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">actionPerformed</span><span class=\"params\">(ActionEvent e)</span> &#123;</span><br><span class=\"line\">                sendText();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        textField.addActionListener(<span class=\"keyword\">new</span> <span class=\"title class_\">ActionListener</span>() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">actionPerformed</span><span class=\"params\">(ActionEvent e)</span> &#123;</span><br><span class=\"line\">                sendText();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        frame.pack();</span><br><span class=\"line\">        frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);</span><br><span class=\"line\">        frame.setVisible(<span class=\"literal\">true</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">setupWriter</span><span class=\"params\">(String filePath)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            writer = <span class=\"keyword\">new</span> <span class=\"title class_\">BufferedWriter</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">FileWriter</span>(filePath, <span class=\"literal\">true</span>));</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">sendText</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">text</span> <span class=\"operator\">=</span> textField.getText();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!text.isEmpty()) &#123;</span><br><span class=\"line\">        \t<span class=\"type\">Message</span> <span class=\"variable\">message</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Message</span> ( <span class=\"number\">0</span> , logicNum , text ) ;</span><br><span class=\"line\">\t\t\t<span class=\"type\">String</span> <span class=\"variable\">messageJson</span> <span class=\"operator\">=</span> MessageUtils.serialize(message) ; </span><br><span class=\"line\">\t\t\tlogicNum = logicNum + <span class=\"number\">1</span> ; </span><br><span class=\"line\">\t\t\tout.println(messageJson);</span><br><span class=\"line\">\t\t\ttextField.setText(<span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">            <span class=\"comment\">/*textArea.append(text + &quot;\\n&quot;);</span></span><br><span class=\"line\"><span class=\"comment\">            </span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">            try &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                writer.write(text);</span></span><br><span class=\"line\"><span class=\"comment\">                writer.newLine();</span></span><br><span class=\"line\"><span class=\"comment\">                writer.flush();</span></span><br><span class=\"line\"><span class=\"comment\">            &#125; catch (IOException e) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                e.printStackTrace();</span></span><br><span class=\"line\"><span class=\"comment\">            &#125;*/</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">appendText</span><span class=\"params\">(String text)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!text.isEmpty()) &#123;</span><br><span class=\"line\">            textArea.append(text + <span class=\"string\">&quot;\\n&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                writer.write(text);</span><br><span class=\"line\">                writer.newLine();</span><br><span class=\"line\">                writer.flush();</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">                e.printStackTrace();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"messagequeue-2\"><a class=\"markdownIt-Anchor\" href=\"#messagequeue-2\">#</a> MessageQueue</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">package</span> p2psystem;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.*;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MessageQueue</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> PriorityQueue&lt;Message&gt; messageQueue;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Map&lt;Long, Integer&gt; idCounts;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Map&lt;Long, Integer&gt; broadCounts;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">MessageQueue</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 初始化优先队列和ID计数器</span></span><br><span class=\"line\">        messageQueue = <span class=\"keyword\">new</span> <span class=\"title class_\">PriorityQueue</span>&lt;&gt;(Comparator.comparingLong(Message::getseq));</span><br><span class=\"line\">        idCounts = <span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;&gt;();</span><br><span class=\"line\">        broadCounts = <span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;&gt;() ; </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 添加消息到队列</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">addMessage</span><span class=\"params\">(Message message)</span> &#123;</span><br><span class=\"line\">        messageQueue.offer(message); <span class=\"comment\">// 添加到优先队列</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">incrementBroadCount</span> <span class=\"params\">( Message message )</span> &#123;</span><br><span class=\"line\">    \tbroadCounts.put(message.getId(), <span class=\"number\">1</span> ) ; </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">int</span> <span class=\"title function_\">getBroadCount</span> <span class=\"params\">( <span class=\"type\">long</span> id )</span> &#123; </span><br><span class=\"line\">    \t<span class=\"keyword\">return</span> broadCounts.getOrDefault(id, <span class=\"number\">0</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 增加id的ACK计数</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">incrementIdCount</span> <span class=\"params\">( Message message )</span> &#123;</span><br><span class=\"line\">    \tidCounts.put(message.getId(), idCounts.getOrDefault(message.getId(), <span class=\"number\">0</span>) + <span class=\"number\">1</span>); <span class=\"comment\">// 增加ID计数</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 删除指定ID的消息</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">removeMessage</span><span class=\"params\">(<span class=\"type\">long</span> id)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 创建一个新的优先队列用于存储剩余的消息</span></span><br><span class=\"line\">        PriorityQueue&lt;Message&gt; newQueue = <span class=\"keyword\">new</span> <span class=\"title class_\">PriorityQueue</span>&lt;&gt;(Comparator.comparingLong(Message::getseq));</span><br><span class=\"line\">        <span class=\"comment\">// 从原队列中移除所有指定ID的消息，并更新ID计数</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> (!messageQueue.isEmpty()) &#123;</span><br><span class=\"line\">            <span class=\"type\">Message</span> <span class=\"variable\">message</span> <span class=\"operator\">=</span> messageQueue.poll();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (message.getId() != id) &#123;</span><br><span class=\"line\">                newQueue.offer(message); <span class=\"comment\">// 将非指定ID的消息添加到新队列中</span></span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                idCounts.put(id, <span class=\"number\">0</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 更新队列为新队列</span></span><br><span class=\"line\">        messageQueue = newQueue;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 获取头部信息</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Message <span class=\"title function_\">getHeadMessage</span> <span class=\"params\">( )</span> &#123;</span><br><span class=\"line\">    \t<span class=\"keyword\">return</span> messageQueue.peek() ; </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 获取队列中的所有消息</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> List&lt;Message&gt; <span class=\"title function_\">getAllMessages</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;&gt;(messageQueue);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 获取指定ID的消息数量</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">int</span> <span class=\"title function_\">getMessageCount</span><span class=\"params\">(<span class=\"type\">long</span> id)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> idCounts.getOrDefault(id, <span class=\"number\">0</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 打印队列中的所有消息</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">printAllMessages</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;All Messages in the Queue:&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (Message message : messageQueue) &#123;</span><br><span class=\"line\">            System.out.println(message.toString());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"message\"><a class=\"markdownIt-Anchor\" href=\"#message\">#</a> Message</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">package</span> p2psystem;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.Serializable;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Message</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">Serializable</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">serialVersionUID</span> <span class=\"operator\">=</span> <span class=\"number\">1L</span> ; </span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"type\">long</span> id ; </span><br><span class=\"line\">\t<span class=\"keyword\">private</span> String content ; </span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"type\">int</span> seq ; </span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"title function_\">Message</span> <span class=\"params\">( <span class=\"type\">long</span> id , <span class=\"type\">int</span> seq , String content )</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">this</span>.id = id ; </span><br><span class=\"line\">\t\t<span class=\"built_in\">this</span>.seq = seq ; </span><br><span class=\"line\">\t\t<span class=\"built_in\">this</span>.content = content ; </span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"type\">long</span> <span class=\"title function_\">getId</span> <span class=\"params\">( )</span> &#123; <span class=\"keyword\">return</span> id ; &#125; </span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">setId</span> <span class=\"params\">( <span class=\"type\">long</span> id )</span> &#123; <span class=\"built_in\">this</span>.id = id ; &#125; </span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"type\">int</span> <span class=\"title function_\">getseq</span> <span class=\"params\">( )</span> &#123; <span class=\"keyword\">return</span> seq ; &#125; </span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">setseq</span> <span class=\"params\">( <span class=\"type\">int</span> seq )</span> &#123; <span class=\"built_in\">this</span>.seq = seq ; &#125; </span><br><span class=\"line\">\t<span class=\"keyword\">public</span> String <span class=\"title function_\">getContent</span> <span class=\"params\">( )</span> &#123; <span class=\"keyword\">return</span> content ; &#125; </span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">setContent</span> <span class=\"params\">( String content )</span> &#123; <span class=\"built_in\">this</span>.content = content ; &#125; </span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> String <span class=\"title function_\">toString</span> <span class=\"params\">( )</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"string\">&quot;Message&#123;&quot;</span>+</span><br><span class=\"line\">\t\t\t\t<span class=\"string\">&quot;id=&quot;</span>+id+</span><br><span class=\"line\">\t\t\t\t<span class=\"string\">&quot;,seq=&quot;</span>+seq+</span><br><span class=\"line\">\t\t\t\t<span class=\"string\">&quot;,content=&#x27;&quot;</span>+content+<span class=\"string\">&#x27;\\&#x27;&#x27;</span>+</span><br><span class=\"line\">\t\t\t\t<span class=\"string\">&#x27;&#125;&#x27;</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"messageutils\"><a class=\"markdownIt-Anchor\" href=\"#messageutils\">#</a> MessageUtils</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">package</span> p2psystem;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.google.gson.Gson;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MessageUtils</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">Gson</span> <span class=\"variable\">gson</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Gson</span> ( ) ; </span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title function_\">serialize</span> <span class=\"params\">( Message message )</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> gson.toJson(message) ; </span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Message <span class=\"title function_\">deserialize</span> <span class=\"params\">( String json )</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> gson.fromJson(json, Message.class) ; </span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"实现效果\"><a class=\"markdownIt-Anchor\" href=\"#实现效果\">#</a> 实现效果</h1>\n<p><img data-src=\"8.png\" alt=\"\"><br>\n当我们在文本框中输入想发送的信息后，点击 Send 该信息会在 Client 各自的显示界面中出现，对于不同文本框输入的值，我们可以发现 Id 号是严格递增的符合预期，Seq 代表的逻辑序号也是递增的，符合我们实现的原理。可以看到在后台的命令指示符中各自的程序也都是良好的运行，符合预期！</p>\n",
            "tags": [
                "代码",
                "分布式"
            ]
        },
        {
            "id": "http://amentiraz.github.io/2024/05/10/%E5%88%86%E5%B8%83%E5%BC%8FMOM%E4%BD%9C%E4%B8%9A/",
            "url": "http://amentiraz.github.io/2024/05/10/%E5%88%86%E5%B8%83%E5%BC%8FMOM%E4%BD%9C%E4%B8%9A/",
            "title": "分布式MOM作业",
            "date_published": "2024-05-10T09:07:10.000Z",
            "content_html": "<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>分布式作业</p>\n<span id=\"more\"></span>\n<h1 id=\"问题重述\"><a class=\"markdownIt-Anchor\" href=\"#问题重述\">#</a> 问题重述</h1>\n<p><img data-src=\"homework.png\" alt=\"\"></p>\n<h1 id=\"实验原理\"><a class=\"markdownIt-Anchor\" href=\"#实验原理\">#</a> 实验原理</h1>\n<p>这段代码涉及到 Java 消息服务（JMS）和消息代理（Apache ActiveMQ），它们是用于构建分布式、可靠和异步消息传递系统的关键技术。</p>\n<p><strong>JMS</strong> 是 Java 中用于发送和接收消息的 API 规范，它提供了一种标准的方式来创建、发送、接收和管理消息。JMS 有两种消息传递模型：点对点（Point-to-Point）和发布 / 订阅（Publish/Subscribe）。在这个例子中，我们使用的是发布 / 订阅模型。</p>\n<p><strong>消息代理</strong> 是一个中间件系统，负责将消息从发送者传递给接收者。Apache ActiveMQ 是一个流行的开源消息代理，它实现了 JMS 规范，并提供了可靠的消息传递机制。在这个例子中，ActiveMQ 充当了消息代理的角色，负责管理消息的传递和路由。</p>\n<h1 id=\"开发环境\"><a class=\"markdownIt-Anchor\" href=\"#开发环境\">#</a> 开发环境</h1>\n<h2 id=\"软件版本\"><a class=\"markdownIt-Anchor\" href=\"#软件版本\">#</a> 软件版本</h2>\n<p>Windows11<br>\nEclipse IDE for Java Developers - 2022-03<br>\nJava 1.8<br>\nActive MQ 6.1.0<br>\nXchart 3.8.1<br>\nMaven3.6.1</p>\n<p><img data-src=\"evm.png\" alt=\"\"></p>\n<h2 id=\"pom文件配置\"><a class=\"markdownIt-Anchor\" href=\"#pom文件配置\">#</a> pom 文件配置</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class=\"line\">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br><span class=\"line\">         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class=\"line\">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class=\"line\">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;properties&gt;</span><br><span class=\"line\">        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br><span class=\"line\">        &lt;maven.compiler.encoding&gt;UTF-8&lt;/maven.compiler.encoding&gt;</span><br><span class=\"line\">        &lt;java.version&gt;21&lt;/java.version&gt;</span><br><span class=\"line\">        &lt;maven.compiler.source&gt;21&lt;/maven.compiler.source&gt;</span><br><span class=\"line\">        &lt;maven.compiler.target&gt;21&lt;/maven.compiler.target&gt;</span><br><span class=\"line\">    &lt;/properties&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;groupId&gt;com.xidian.dc.mq&lt;/groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;mq-topic&lt;/artifactId&gt;</span><br><span class=\"line\">    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span><br><span class=\"line\">    </span><br><span class=\"line\">    &lt;dependencies&gt;     </span><br><span class=\"line\">        &lt;!-- https://mvnrepository.com/artifact/org.apache.activemq/activemq-all --&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">\t        &lt;groupId&gt;org.knowm.xchart&lt;/groupId&gt;</span><br><span class=\"line\">\t        &lt;artifactId&gt;xchart&lt;/artifactId&gt;</span><br><span class=\"line\">\t        &lt;version&gt;3.8.1&lt;/version&gt;</span><br><span class=\"line\">        &lt;/dependency&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;org.jfree&lt;/groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;jfreechart&lt;/artifactId&gt;</span><br><span class=\"line\">            &lt;version&gt;1.5.3&lt;/version&gt;</span><br><span class=\"line\">        &lt;/dependency&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;jakarta.jms&lt;/groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;jakarta.jms-api&lt;/artifactId&gt;</span><br><span class=\"line\">            &lt;version&gt;3.1.0&lt;/version&gt;</span><br><span class=\"line\">        &lt;/dependency&gt;</span><br><span class=\"line\">\t\t&lt;dependency&gt;</span><br><span class=\"line\">\t\t\t&lt;groupId&gt;org.apache.activemq&lt;/groupId&gt;</span><br><span class=\"line\">\t\t\t&lt;artifactId&gt;activemq-all&lt;/artifactId&gt;</span><br><span class=\"line\">\t\t\t&lt;version&gt;6.1.0&lt;/version&gt;</span><br><span class=\"line\">\t\t&lt;/dependency&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;log4j-api&lt;/artifactId&gt;</span><br><span class=\"line\">            &lt;version&gt;2.17.2&lt;/version&gt;</span><br><span class=\"line\">        &lt;/dependency&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;log4j-core&lt;/artifactId&gt;</span><br><span class=\"line\">            &lt;version&gt;2.17.2&lt;/version&gt;</span><br><span class=\"line\">        &lt;/dependency&gt;</span><br><span class=\"line\">    &lt;/dependencies&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\">&lt;/project&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h1 id=\"设计思路\"><a class=\"markdownIt-Anchor\" href=\"#设计思路\">#</a> 设计思路</h1>\n<h2 id=\"构架图\"><a class=\"markdownIt-Anchor\" href=\"#构架图\">#</a> 构架图</h2>\n<p><img data-src=\"stream.jpg\" alt=\"\"></p>\n<h2 id=\"各个代码的用途\"><a class=\"markdownIt-Anchor\" href=\"#各个代码的用途\">#</a> 各个代码的用途</h2>\n<h3 id=\"publisher\"><a class=\"markdownIt-Anchor\" href=\"#publisher\">#</a> Publisher</h3>\n<p>随机信号产生器微服务，生成正太分布的随机数字并发布在 MYTOPIC 服务上<br>\n生成方式’double randomNumner = random.nextGaussian () * stdDev + mean ; ’<br>\n通过传输 main 函数的变量来区分不同的产生器</p>\n<h3 id=\"asyncconsumer\"><a class=\"markdownIt-Anchor\" href=\"#asyncconsumer\">#</a> ASyncConsumer</h3>\n<p>随机信号统计分析微服务，并将处理后的数据发布在 DATA 服务上<br>\n storeMessage: 对传输过来的数据进行处理并存储<br>\n publisher: 对存储的数据进行统计和发布</p>\n<h3 id=\"mylistener\"><a class=\"markdownIt-Anchor\" href=\"#mylistener\">#</a> MyListener</h3>\n<p>实现 MessageListener 接口，并接收存储数据。实现对 ASyncConsumer 的 consumer 的处理</p>\n<h3 id=\"showconsumer\"><a class=\"markdownIt-Anchor\" href=\"#showconsumer\">#</a> ShowConsumer</h3>\n<p>实时数据显示微服务，并调用 RealTimeChart 实现数据的可视化<br>\n paint: 通过调用 RealTimeChart 里面的 plot 来实现实时绘制图像</p>\n<h3 id=\"mylistener1\"><a class=\"markdownIt-Anchor\" href=\"#mylistener1\">#</a> MyListener1</h3>\n<p>实现 MessageListener 接口，并接收存储数据。实现对 ShowConsumer 的 consumer 的处理</p>\n<h3 id=\"realtimechart\"><a class=\"markdownIt-Anchor\" href=\"#realtimechart\">#</a> RealTimeChart</h3>\n<p>实现实时画图</p>\n<h1 id=\"commands\"><a class=\"markdownIt-Anchor\" href=\"#commands\">#</a> Commands</h1>\n<p>mvn clean<br>\nmvn compile</p>\n<p>mvn exec:java -Dexec.mainClass=“ASyncConsumer”</p>\n<p>mvn exec:java -Dexec.mainClass=“ShowConsumer”</p>\n<p>mvn exec:java -Dexec.mainClass=“Publisher” -Dexec.args=“1”<br>\nmvn exec:java -Dexec.mainClass=“Publisher” -Dexec.args=“2”<br>\nmvn exec:java -Dexec.mainClass=“Publisher” -Dexec.args=“3”<br>\nmvn exec:java -Dexec.mainClass=“Publisher” -Dexec.args=“4”</p>\n<h1 id=\"java程序\"><a class=\"markdownIt-Anchor\" href=\"#java程序\">#</a> JAVA 程序</h1>\n<h2 id=\"mylistenerjava\"><a class=\"markdownIt-Anchor\" href=\"#mylistenerjava\">#</a> MyListener.java</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.Message;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.MessageListener;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.ObjectMessage;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.Message;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.TextMessage;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyListener</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">MessageListener</span> &#123;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">private</span> ASyncConsumer consumer ; </span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"title function_\">MyListener</span> <span class=\"params\">( ASyncConsumer consumer )</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">this</span>.consumer = consumer ; </span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onMessage</span><span class=\"params\">(Message message)</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"type\">String</span> <span class=\"variable\">text</span> <span class=\"operator\">=</span> ((TextMessage) message).getText() ; </span><br><span class=\"line\">\t\t\tSystem.out.println(<span class=\"string\">&quot;Received a message: &quot;</span>+text);</span><br><span class=\"line\">\t\t\tconsumer.storeMessage(text);</span><br><span class=\"line\">\t\t\tconsumer.publisher(<span class=\"string\">&quot;ACK&quot;</span>);</span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">\t\t\te.printStackTrace();</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"publisherjava\"><a class=\"markdownIt-Anchor\" href=\"#publisherjava\">#</a> Publisher.java</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.Connection;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Random ; </span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.ConnectionFactory;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.Destination;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.JMSException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.Message;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.MessageProducer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.ObjectMessage;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.Session;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.Topic;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.activemq.ActiveMQConnectionFactory;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Publisher</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"type\">String</span> <span class=\"variable\">brokerURL</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;tcp://localhost:61616&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> ConnectionFactory factory;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Connection connection;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Session session;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> MessageProducer producer;</span><br><span class=\"line\">\t<span class=\"keyword\">private</span> Topic topic;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">Publisher</span><span class=\"params\">(String topicName)</span> <span class=\"keyword\">throws</span> JMSException &#123;</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">    \tfactory = <span class=\"keyword\">new</span> <span class=\"title class_\">ActiveMQConnectionFactory</span>(brokerURL);</span><br><span class=\"line\">    \tconnection = factory.createConnection();</span><br><span class=\"line\">        </span><br><span class=\"line\">        session = connection.createSession(<span class=\"literal\">false</span>, Session.AUTO_ACKNOWLEDGE);</span><br><span class=\"line\">\t\ttopic = session.createTopic(topicName);</span><br><span class=\"line\">        producer = session.createProducer(topic);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tconnection.start();</span><br><span class=\"line\">    &#125;    </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">close</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> JMSException &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (connection != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            connection.close();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;    </span><br><span class=\"line\">    </span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> JMSException &#123;</span><br><span class=\"line\">    \t<span class=\"type\">Publisher</span> <span class=\"variable\">publisher</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Publisher</span>(<span class=\"string\">&quot;MYTOPIC&quot;</span>);</span><br><span class=\"line\">    \tSystem.out.println(args[<span class=\"number\">0</span>]) ; </span><br><span class=\"line\">    \t<span class=\"keyword\">while</span> ( <span class=\"literal\">true</span> ) &#123;</span><br><span class=\"line\">    \t\tpublisher.sendMessage(args[<span class=\"number\">0</span>]);</span><br><span class=\"line\">        \t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\t\tThread.sleep(<span class=\"number\">1000</span>);</span><br><span class=\"line\">\t\t\t&#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// TODO Auto-generated catch block</span></span><br><span class=\"line\">\t\t\t\tpublisher.close();</span><br><span class=\"line\">\t\t\t\te.printStackTrace();</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">    \t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">sendMessage</span><span class=\"params\">(String UID )</span> <span class=\"keyword\">throws</span> JMSException &#123;</span><br><span class=\"line\">        <span class=\"type\">Random</span> <span class=\"variable\">random</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Random</span>( ) ;</span><br><span class=\"line\">    \t<span class=\"type\">int</span> <span class=\"variable\">num</span> <span class=\"operator\">=</span> Integer.parseInt(UID) ;</span><br><span class=\"line\">        <span class=\"type\">double</span> <span class=\"variable\">mean</span> <span class=\"operator\">=</span> num ; </span><br><span class=\"line\">        <span class=\"type\">double</span> <span class=\"variable\">stdDev</span> <span class=\"operator\">=</span> <span class=\"number\">1</span> ; </span><br><span class=\"line\">        <span class=\"type\">double</span> <span class=\"variable\">randomNumner</span> <span class=\"operator\">=</span> random.nextGaussian() * stdDev + mean ; </span><br><span class=\"line\">        <span class=\"type\">Message</span> <span class=\"variable\">message</span> <span class=\"operator\">=</span> session.createTextMessage(UID+<span class=\"string\">&quot;+&quot;</span>+Double.toString(randomNumner));</span><br><span class=\"line\">\t\t<span class=\"comment\">//for(int i=0;i&lt;15;i++)&#123;</span></span><br><span class=\"line\">\t\tproducer.send(message);</span><br><span class=\"line\">\t\tSystem.out.println(<span class=\"string\">&quot;Sent a message!&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"comment\">//&#125;</span></span><br><span class=\"line\">    &#125;\t</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">sendData</span> <span class=\"params\">( String Data )</span> <span class=\"keyword\">throws</span> JMSException &#123;</span><br><span class=\"line\">    \t<span class=\"type\">Message</span> <span class=\"variable\">message</span> <span class=\"operator\">=</span> session.createTextMessage(Data) ; </span><br><span class=\"line\">    \tproducer.send(message);</span><br><span class=\"line\">    \tSystem.out.println (<span class=\"string\">&quot;Sent a Data!&quot;</span>) ; </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"asyncconsumerjava\"><a class=\"markdownIt-Anchor\" href=\"#asyncconsumerjava\">#</a> ASyncConsumer.java</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.Connection;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.ConnectionFactory;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.Destination;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.JMSException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.MessageConsumer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.MessageProducer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.Session;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.Message;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.TextMessage;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.Topic;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.ArrayList ; </span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.List; </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.activemq.ActiveMQConnectionFactory;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ASyncConsumer</span> &#123;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">private</span> List&lt;String&gt; messages ; </span><br><span class=\"line\">\t<span class=\"keyword\">private</span> List&lt;Double&gt;[] arrayOfLists = <span class=\"keyword\">new</span> <span class=\"title class_\">List</span>[<span class=\"number\">5</span>] ;  </span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"title function_\">ASyncConsumer</span> <span class=\"params\">( )</span> &#123;</span><br><span class=\"line\">\t\tmessages = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;&gt;() ; </span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> ( <span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span> ; i &lt; arrayOfLists.length ; i ++ ) &#123;</span><br><span class=\"line\">\t\t\tarrayOfLists[i] = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;&gt;() ; </span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">storeMessage</span> <span class=\"params\">( String message )</span> &#123; </span><br><span class=\"line\">\t\tmessages.add(message) ; </span><br><span class=\"line\">\t\tString[] parts = message.split(<span class=\"string\">&quot;\\\\+&quot;</span>) ; </span><br><span class=\"line\">\t\t<span class=\"type\">String</span> <span class=\"variable\">intPart</span> <span class=\"operator\">=</span> parts[<span class=\"number\">0</span>] ; </span><br><span class=\"line\">\t\t<span class=\"type\">String</span> <span class=\"variable\">doublePart</span> <span class=\"operator\">=</span> parts[<span class=\"number\">1</span>] ; </span><br><span class=\"line\">\t\t<span class=\"type\">int</span> <span class=\"variable\">uid</span> <span class=\"operator\">=</span> Integer.parseInt(intPart) ; </span><br><span class=\"line\">\t\t<span class=\"type\">double</span> <span class=\"variable\">val</span> <span class=\"operator\">=</span> Double.parseDouble(doublePart) ; </span><br><span class=\"line\">\t\tarrayOfLists[uid].add(val) ; </span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> List&lt;String&gt; <span class=\"title function_\">getMessages</span> <span class=\"params\">( )</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> messages ; </span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">printMessages</span> <span class=\"params\">( )</span> &#123;</span><br><span class=\"line\">\t\tSystem.out.println(<span class=\"string\">&quot;Messages:&quot;</span>) ; </span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> ( String message : messages ) &#123;</span><br><span class=\"line\">\t\t\tSystem.out.print ( <span class=\"string\">&quot;orz&quot;</span> + message ) ; </span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"type\">double</span> <span class=\"title function_\">calculateMean</span><span class=\"params\">(List&lt;Double&gt; data)</span> &#123;</span><br><span class=\"line\">        <span class=\"type\">double</span> <span class=\"variable\">sum</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">double</span> value : data) &#123;</span><br><span class=\"line\">            sum += value;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( data.size() == <span class=\"number\">0</span> ) <span class=\"keyword\">return</span> <span class=\"number\">0</span> ; </span><br><span class=\"line\">        <span class=\"keyword\">return</span> sum / data.size();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"type\">double</span> <span class=\"title function_\">calculateVariance</span><span class=\"params\">(List&lt;Double&gt; data, <span class=\"type\">double</span> mean)</span> &#123;</span><br><span class=\"line\">        <span class=\"type\">double</span> <span class=\"variable\">sumSquaredDiff</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">double</span> value : data) &#123;</span><br><span class=\"line\">            sumSquaredDiff += Math.pow(value - mean, <span class=\"number\">2</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( data.size() == <span class=\"number\">0</span> ) <span class=\"keyword\">return</span> <span class=\"number\">0</span> ; </span><br><span class=\"line\">        <span class=\"keyword\">return</span> sumSquaredDiff / data.size();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">publisher</span> <span class=\"params\">( String topicname )</span> <span class=\"keyword\">throws</span> JMSException &#123;</span><br><span class=\"line\">\t\t<span class=\"type\">Publisher</span> <span class=\"variable\">publisher</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Publisher</span>(<span class=\"string\">&quot;DATA&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"type\">int</span> <span class=\"variable\">n</span> <span class=\"operator\">=</span> <span class=\"number\">5</span> ; </span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> ( <span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span> ; i &lt; <span class=\"number\">5</span> ; i ++ ) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"type\">double</span> <span class=\"variable\">mean</span> <span class=\"operator\">=</span> calculateMean (arrayOfLists[i].subList(Math.max(arrayOfLists[i].size()-n, <span class=\"number\">0</span>),arrayOfLists[i].size())) ; </span><br><span class=\"line\">\t\t\t<span class=\"type\">double</span> <span class=\"variable\">variance</span> <span class=\"operator\">=</span> calculateVariance (arrayOfLists[i].subList(Math.max(arrayOfLists[i].size()-n, <span class=\"number\">0</span>),arrayOfLists[i].size()),mean) ; </span><br><span class=\"line\">\t\t\t<span class=\"type\">double</span> <span class=\"variable\">Max</span> <span class=\"operator\">=</span> arrayOfLists[i].stream().mapToDouble(Double::doubleValue).max().orElse(<span class=\"number\">0</span>) ; </span><br><span class=\"line\">\t\t\t<span class=\"type\">double</span> <span class=\"variable\">Min</span> <span class=\"operator\">=</span> arrayOfLists[i].stream().mapToDouble(Double::doubleValue).min().orElse(<span class=\"number\">0</span>) ;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">//if ( Max == Double.NaN ) Max = 0 ; </span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">//if ( Min == Double.NaN ) Min = 0 ; </span></span><br><span class=\"line\">\t\t\t<span class=\"type\">double</span> <span class=\"variable\">cur</span> <span class=\"operator\">=</span> <span class=\"number\">0</span> ; </span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> ( arrayOfLists[i].size() != <span class=\"number\">0</span> )</span><br><span class=\"line\">\t\t\t\tcur = arrayOfLists[i].get(arrayOfLists[i].size()-<span class=\"number\">1</span>) ; </span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span> </span><br><span class=\"line\">\t\t\t\tcur = <span class=\"number\">0</span> ; </span><br><span class=\"line\">\t\t\t<span class=\"type\">String</span> <span class=\"variable\">Data</span> <span class=\"operator\">=</span> Integer.toString(i)+<span class=\"string\">&quot;+&quot;</span>+Double.toString(mean)+<span class=\"string\">&quot;+&quot;</span>+Double.toString(variance)+<span class=\"string\">&quot;+&quot;</span>+Double.toString(Max)+<span class=\"string\">&quot;+&quot;</span>+Double.toString(Min)+<span class=\"string\">&quot;+&quot;</span>+Double.toString(cur); </span><br><span class=\"line\">\t\t\tpublisher.sendData(Data);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> JMSException &#123;</span><br><span class=\"line\">    \t<span class=\"type\">ASyncConsumer</span> <span class=\"variable\">consumer</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ASyncConsumer</span> ( ) ; </span><br><span class=\"line\">    \t</span><br><span class=\"line\">\t\t<span class=\"type\">String</span> <span class=\"variable\">brokerURL</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;tcp://localhost:61616&quot;</span>;</span><br><span class=\"line\">\t\t<span class=\"type\">ConnectionFactory</span> <span class=\"variable\">factory</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">\t\t<span class=\"type\">Connection</span> <span class=\"variable\">connection</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">\t\t<span class=\"type\">Session</span> <span class=\"variable\">session</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">\t\t<span class=\"type\">Topic</span> <span class=\"variable\">topic</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">\t\t<span class=\"type\">MessageConsumer</span> <span class=\"variable\">messageConsumer</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">\t\t<span class=\"type\">MyListener</span> <span class=\"variable\">listener</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">        </span><br><span class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\tfactory = <span class=\"keyword\">new</span> <span class=\"title class_\">ActiveMQConnectionFactory</span>(brokerURL);</span><br><span class=\"line\">\t\t\tconnection = factory.createConnection();</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\tsession = connection.createSession(<span class=\"literal\">false</span>, Session.AUTO_ACKNOWLEDGE);</span><br><span class=\"line\">\t\t\ttopic = session.createTopic(<span class=\"string\">&quot;MYTOPIC&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tmessageConsumer = session.createConsumer(topic);</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\tlistener = <span class=\"keyword\">new</span> <span class=\"title class_\">MyListener</span>(consumer);</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\tmessageConsumer.setMessageListener(listener);</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\tconnection.start();</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\t<span class=\"comment\">//consumer.printMessages();</span></span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\tSystem.out.println(<span class=\"string\">&quot;Press any key to exit.&quot;</span>);</span><br><span class=\"line\">\t\t\tSystem.in.read();   <span class=\"comment\">// Pause</span></span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">\t\t\te.printStackTrace();</span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">\t\t\tconnection.close();</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"showconsumer-2\"><a class=\"markdownIt-Anchor\" href=\"#showconsumer-2\">#</a> ShowConsumer</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.Connection;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.ConnectionFactory;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.Destination;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.JMSException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.MessageConsumer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.MessageProducer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.Session;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.Message;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.TextMessage;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.Topic;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.ArrayList ; </span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.List; </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.activemq.ActiveMQConnectionFactory;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ShowConsumer</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">private</span> List&lt;Double&gt;[][] arrayOfLists = <span class=\"keyword\">new</span> <span class=\"title class_\">List</span>[<span class=\"number\">6</span>][<span class=\"number\">5</span>] ; </span><br><span class=\"line\">\tRealTimeChart[] chart = <span class=\"keyword\">new</span> <span class=\"title class_\">RealTimeChart</span>[<span class=\"number\">6</span>] ; </span><br><span class=\"line\">\t<span class=\"comment\">// 数组1，2，3，4,5分别代表均值，方差，最大值，最小值,目前值</span></span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"title function_\">ShowConsumer</span> <span class=\"params\">( )</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> ( <span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">1</span> ; i &lt; <span class=\"number\">6</span> ; i ++ ) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">for</span> ( <span class=\"type\">int</span> <span class=\"variable\">j</span> <span class=\"operator\">=</span> <span class=\"number\">0</span> ; j &lt; <span class=\"number\">5</span> ; j ++ ) &#123;</span><br><span class=\"line\">\t\t\t\tarrayOfLists[i][j] = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;&gt;() ; </span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> ( <span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">1</span> ; i &lt; <span class=\"number\">6</span> ; i ++ ) &#123;</span><br><span class=\"line\">\t\t\tchart[i] = <span class=\"keyword\">new</span> <span class=\"title class_\">RealTimeChart</span> ( <span class=\"string\">&quot;History Data&quot;</span> , <span class=\"string\">&quot;UID&quot;</span>+Integer.toString(i) , <span class=\"number\">500</span> ) ; </span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">paint</span> <span class=\"params\">( )</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> ( <span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">1</span> ; i &lt; <span class=\"number\">6</span> ; i ++ ) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> ( arrayOfLists[i][<span class=\"number\">4</span>].size() != <span class=\"number\">0</span> )</span><br><span class=\"line\">\t\t\t\tchart[i].plot(arrayOfLists[i][<span class=\"number\">4</span>].get(arrayOfLists[i][<span class=\"number\">4</span>].size()-<span class=\"number\">1</span>));</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">storeMessage</span> <span class=\"params\">( String message )</span> &#123; </span><br><span class=\"line\">\t\tString[] parts = message.split(<span class=\"string\">&quot;\\\\+&quot;</span>) ; </span><br><span class=\"line\">\t\t<span class=\"type\">String</span> <span class=\"variable\">uidPart</span> <span class=\"operator\">=</span> parts[<span class=\"number\">0</span>] ; </span><br><span class=\"line\">\t\t<span class=\"type\">String</span> <span class=\"variable\">meanPart</span> <span class=\"operator\">=</span> parts[<span class=\"number\">1</span>] ; </span><br><span class=\"line\">\t\t<span class=\"type\">String</span> <span class=\"variable\">variancePart</span> <span class=\"operator\">=</span> parts[<span class=\"number\">2</span>] ; </span><br><span class=\"line\">\t\t<span class=\"type\">String</span> <span class=\"variable\">maxPart</span> <span class=\"operator\">=</span> parts[<span class=\"number\">3</span>] ; </span><br><span class=\"line\">\t\t<span class=\"type\">String</span> <span class=\"variable\">minPart</span> <span class=\"operator\">=</span> parts[<span class=\"number\">4</span>] ; </span><br><span class=\"line\">\t\t<span class=\"type\">String</span> <span class=\"variable\">curPart</span> <span class=\"operator\">=</span> parts[<span class=\"number\">5</span>] ; </span><br><span class=\"line\">\t\t<span class=\"type\">int</span> <span class=\"variable\">uid</span> <span class=\"operator\">=</span> Integer.parseInt(uidPart) ; </span><br><span class=\"line\">\t\t<span class=\"type\">double</span> <span class=\"variable\">mean</span> <span class=\"operator\">=</span> Double.parseDouble(meanPart) ; </span><br><span class=\"line\">\t\t<span class=\"type\">double</span> <span class=\"variable\">variance</span> <span class=\"operator\">=</span> Double.parseDouble(variancePart) ;</span><br><span class=\"line\">\t\t<span class=\"type\">double</span> <span class=\"variable\">Max</span> <span class=\"operator\">=</span> Double.parseDouble(maxPart) ; </span><br><span class=\"line\">\t\t<span class=\"type\">double</span> <span class=\"variable\">Min</span> <span class=\"operator\">=</span> Double.parseDouble(minPart) ; </span><br><span class=\"line\">\t\t<span class=\"type\">double</span> <span class=\"variable\">cur</span> <span class=\"operator\">=</span> Double.parseDouble(curPart) ; </span><br><span class=\"line\">\t\tarrayOfLists[uid][<span class=\"number\">0</span>].add(mean) ; </span><br><span class=\"line\">\t\tarrayOfLists[uid][<span class=\"number\">1</span>].add(variance) ;</span><br><span class=\"line\">\t\tarrayOfLists[uid][<span class=\"number\">2</span>].add(Max) ;</span><br><span class=\"line\">\t\tarrayOfLists[uid][<span class=\"number\">3</span>].add(Min) ;</span><br><span class=\"line\">\t\tarrayOfLists[uid][<span class=\"number\">4</span>].add(cur) ; </span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> JMSException &#123;</span><br><span class=\"line\">    \t<span class=\"type\">ShowConsumer</span> <span class=\"variable\">consumer</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ShowConsumer</span> ( ) ; </span><br><span class=\"line\">    \t</span><br><span class=\"line\">\t\t<span class=\"type\">String</span> <span class=\"variable\">brokerURL</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;tcp://localhost:61616&quot;</span>;</span><br><span class=\"line\">\t\t<span class=\"type\">ConnectionFactory</span> <span class=\"variable\">factory</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">\t\t<span class=\"type\">Connection</span> <span class=\"variable\">connection</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">\t\t<span class=\"type\">Session</span> <span class=\"variable\">session</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">\t\t<span class=\"type\">Topic</span> <span class=\"variable\">topic</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">\t\t<span class=\"type\">MessageConsumer</span> <span class=\"variable\">messageConsumer</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">\t\t<span class=\"type\">MyListener2</span> <span class=\"variable\">listener</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">        </span><br><span class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\tfactory = <span class=\"keyword\">new</span> <span class=\"title class_\">ActiveMQConnectionFactory</span>(brokerURL);</span><br><span class=\"line\">\t\t\tconnection = factory.createConnection();</span><br><span class=\"line\">\t\t\t\t\t\t</span><br><span class=\"line\">\t\t\tsession = connection.createSession(<span class=\"literal\">false</span>, Session.AUTO_ACKNOWLEDGE);</span><br><span class=\"line\">\t\t\ttopic = session.createTopic(<span class=\"string\">&quot;DATA&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tmessageConsumer = session.createConsumer(topic);</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\tlistener = <span class=\"keyword\">new</span> <span class=\"title class_\">MyListener2</span>(consumer);</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\tmessageConsumer.setMessageListener(listener);</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\tconnection.start();</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\t<span class=\"comment\">//consumer.printMessages();</span></span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\tSystem.out.println(<span class=\"string\">&quot;Press any key to exit.&quot;</span>);</span><br><span class=\"line\">\t\t\tSystem.in.read();   <span class=\"comment\">// Pause</span></span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">\t\t\te.printStackTrace();</span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">\t\t\tconnection.close();</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"mylistener2java\"><a class=\"markdownIt-Anchor\" href=\"#mylistener2java\">#</a> MyListener2.java</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.Message;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.MessageListener;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.ObjectMessage;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.Message;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.jms.TextMessage;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyListener2</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">MessageListener</span> &#123;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">private</span> ShowConsumer consumer ; </span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"title function_\">MyListener2</span> <span class=\"params\">( ShowConsumer consumer )</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">this</span>.consumer = consumer ; </span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onMessage</span><span class=\"params\">(Message message)</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"type\">String</span> <span class=\"variable\">text</span> <span class=\"operator\">=</span> ((TextMessage) message).getText() ; </span><br><span class=\"line\">\t\t\tSystem.out.println(<span class=\"string\">&quot;Received a message2: &quot;</span>+text);</span><br><span class=\"line\">\t\t\tconsumer.storeMessage(text);</span><br><span class=\"line\">\t\t\tconsumer.paint ( ) ; </span><br><span class=\"line\">\t\t\t<span class=\"comment\">//consumer.publisher(&quot;ACK&quot;);</span></span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">\t\t\te.printStackTrace();</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"realtimechartjava\"><a class=\"markdownIt-Anchor\" href=\"#realtimechartjava\">#</a> RealTimeChart.java</h2>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.LinkedList;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.List;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.swing.JFrame;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.knowm.xchart.SwingWrapper;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.knowm.xchart.XYChart;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.knowm.xchart.XYChartBuilder;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.knowm.xchart.style.Styler.ChartTheme;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.knowm.xchart.style.Styler.LegendLayout;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.knowm.xchart.style.Styler.LegendPosition;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">RealTimeChart</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">private</span> SwingWrapper&lt;XYChart&gt; swingWrapper ; </span><br><span class=\"line\">\t<span class=\"keyword\">private</span> XYChart chart ; </span><br><span class=\"line\">\t<span class=\"keyword\">private</span> JFrame frame ; </span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">private</span> String title ; </span><br><span class=\"line\">\t<span class=\"keyword\">private</span> String seriesName ; </span><br><span class=\"line\">\t<span class=\"keyword\">private</span> List&lt;Double&gt; seriesData ; </span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"type\">int</span> <span class=\"variable\">size</span> <span class=\"operator\">=</span> <span class=\"number\">1000</span> ; </span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"type\">int</span> <span class=\"title function_\">getSize</span> <span class=\"params\">( )</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> size ; </span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> String <span class=\"title function_\">getSeriesName</span> <span class=\"params\">( )</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> seriesName ; </span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">setSeeriesName</span> <span class=\"params\">( String seriesName )</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">this</span>.seriesName = seriesName ; </span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> String <span class=\"title function_\">getTitle</span> <span class=\"params\">( )</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> title ; </span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">setTitle</span> <span class=\"params\">( String title )</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">this</span>.title = title ; </span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"title function_\">RealTimeChart</span> <span class=\"params\">( String title , String seriesName )</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">super</span> ( ) ; </span><br><span class=\"line\">\t\t<span class=\"built_in\">this</span>.seriesName = seriesName ; </span><br><span class=\"line\">\t\t<span class=\"built_in\">this</span>.title = title ; </span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"title function_\">RealTimeChart</span> <span class=\"params\">( String title , String seriesName , <span class=\"type\">int</span> size )</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">super</span> ( ) ; </span><br><span class=\"line\">\t\t<span class=\"built_in\">this</span>.seriesName = seriesName ; </span><br><span class=\"line\">\t\t<span class=\"built_in\">this</span>.title = title ;</span><br><span class=\"line\">\t\t<span class=\"built_in\">this</span>.size = size ; </span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">plot</span> <span class=\"params\">( <span class=\"type\">double</span> data )</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( seriesData == <span class=\"literal\">null</span> ) &#123;</span><br><span class=\"line\">\t\t\tseriesData = <span class=\"keyword\">new</span> <span class=\"title class_\">LinkedList</span>&lt;&gt;() ; </span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( seriesData.size( ) == <span class=\"built_in\">this</span>.size ) &#123;</span><br><span class=\"line\">\t\t\tseriesData.clear ( ) ; </span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tseriesData.add(data) ; </span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( swingWrapper == <span class=\"literal\">null</span> ) &#123;</span><br><span class=\"line\">\t\t\tchart = <span class=\"keyword\">new</span> <span class=\"title class_\">XYChartBuilder</span>().width(<span class=\"number\">600</span>).height(<span class=\"number\">450</span>).theme(ChartTheme.Matlab).title(title).build();</span><br><span class=\"line\">\t\t\tchart.addSeries(seriesName, <span class=\"literal\">null</span>, seriesData);</span><br><span class=\"line\">\t\t\tchart.getStyler().setLegendPosition(LegendPosition.OutsideS);<span class=\"comment\">// 设置legend的位置为外底部</span></span><br><span class=\"line\">\t\t\tchart.getStyler().setLegendLayout(LegendLayout.Horizontal);<span class=\"comment\">// 设置legend的排列方式为水平排列</span></span><br><span class=\"line\"> </span><br><span class=\"line\">\t\t\tswingWrapper = <span class=\"keyword\">new</span> <span class=\"title class_\">SwingWrapper</span>&lt;XYChart&gt;(chart);</span><br><span class=\"line\">\t\t\tframe = swingWrapper.displayChart();</span><br><span class=\"line\">\t\t\tframe.setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE);<span class=\"comment\">// 防止关闭窗口时退出</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span> &#123; </span><br><span class=\"line\">\t\t\tchart.updateXYSeries ( seriesName , <span class=\"literal\">null</span> , seriesData , <span class=\"literal\">null</span> ) ; </span><br><span class=\"line\">\t\t\tswingWrapper.repaintChart();</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"实现效果\"><a class=\"markdownIt-Anchor\" href=\"#实现效果\">#</a> 实现效果</h1>\n<p><img data-src=\"Show1.png\" alt=\"\"><br>\n可以看到不同的产生器的数据分布在不同的值之间，产生器 1 徘徊在 1 之间，产生器 2 徘徊在 2 之间以此类推<br>\n可以看到无论是处理器还是产生器在命令指示符中均正常工作，达到实验预期！<br>\n<img data-src=\"topic.png\" alt=\"\"><br>\n观察 topic 界面，可以看出在正常工作，符合预期！</p>\n",
            "tags": [
                "代码",
                "分布式"
            ]
        }
    ]
}